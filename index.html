<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KrushFlow</title>
    <style>
        /* Mobile-First UI */
        body { font-family: sans-serif; margin: 0; padding: 20px; background: #fafafa; }
        #ocr-list { background: white; border: 1px solid #ddd; min-height: 200px; margin: 20px 0; padding: 10px; }
        .ocr-line { border-bottom: 1px solid #eee; padding: 8px 0; font-family: monospace; }
        .btn { width: 100%; padding: 15px; background: #007bff; color: white; border: none; border-radius: 5px; font-weight: bold; margin-bottom: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <button class="btn" onclick="KrushFlow.startNewProject()">NEW PROJECT</button>
    
    <input type="file" id="camera-input" accept="image/*" capture="environment" multiple class="hidden" onchange="KrushFlow.handleCapture(event)">

    <div id="ocr-list">
        <div id="status" style="color: #888;">No project active. Click "New Project" to scan.</div>
    </div>

    <button id="record-btn" class="btn hidden" style="background: #28a745;">RECORD RESULTS</button>

<script>
const KrushFlow = {
    projectId: null,
    masterList: [],

    // 1. Initiate Project Context
    startNewProject: function() {
        this.projectId = `KP_${Date.now()}`;
        this.masterList = [];
        document.getElementById('ocr-list').innerHTML = "Ready for scan...";
        document.getElementById('record-btn').classList.add('hidden');
        
        // Trigger Mobile Camera
        document.getElementById('camera-input').click();
    },

    // 2. Handle Image & OCR (Perception Only)
    handleCapture: async function(event) {
        const files = Array.from(event.target.files);
        if (!files.length) return;

        document.getElementById('status').innerText = "Processing Image (Perception-Only)...";

        for (const file of files) {
            try {
                const base64 = await this.toBase64(file);
                const text = await this.callVisionAPI(base64);
                
                // Clean lines: No interpretation, just trimming whitespace
                const lines = text.split('\n')
                    .map(l => l.trim())
                    .filter(l => l.length > 0);
                
                this.masterList.push(...lines);
                this.updateUI();
            } catch (err) {
                console.error("Image failed:", err);
            }
        }
        
        this.saveCanonicalFile();
        this.autosaveToCloud();
    },

    // 3. API Call using Railway Env Variable
    callVisionAPI: async function(base64) {
        // Railway injects this into the environment; make sure it's accessible
        const API_KEY = "[[INSERT_YOUR_GOOGLE_API_KEY_HERE]]" || window.GOOGLE_API_KEY; 
        const url = `https://vision.googleapis.com/v1/images:annotate?key=${API_KEY}`;
        
        const res = await fetch(url, {
            method: 'POST',
            body: JSON.stringify({
                requests: [{
                    image: { content: base64.split(',')[1] },
                    features: [{ type: "DOCUMENT_TEXT_DETECTION" }]
                }]
            })
        });
        const data = await res.json();
        return data.responses[0]?.fullTextAnnotation?.text || "";
    },

    // 4. Persistence & UI
    updateUI: function() {
        const container = document.getElementById('ocr-list');
        container.innerHTML = this.masterList
            .map(line => `<div class="ocr-line">${line}</div>`)
            .join('');
        document.getElementById('record-btn').classList.remove('hidden');
    },

    saveCanonicalFile: function() {
        const content = this.masterList.join('\n');
        localStorage.setItem('source_ocr.txt', content);
    },

    autosaveToCloud: async function() {
        const profile = localStorage.getItem('KrushProfile') || "{}";
        // Simple background ping to your Railway server (optional fallback)
        fetch('/api/backup', { method: 'POST', body: profile }).catch(() => {
            console.log("Local save only. Server backup pending connection.");
        });
    },

    toBase64: file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
    })
};
</script>
</body>
</html>
