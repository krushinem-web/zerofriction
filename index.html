<button id="new-project-btn" onclick="KF.start()">NEW PROJECT</button>
<input type="file" id="cam" accept="image/*" capture="environment" multiple style="display:none" onchange="KF.process(event)">
<div id="ocr-results" style="white-space: pre-wrap; font-family: monospace; border: 1px solid #ccc; padding: 10px; margin-top: 20px;"></div>

<script>
const KF = {
    projectId: null,
    lines: [],

    start: function() {
        this.projectId = Date.now();
        this.lines = [];
        document.getElementById('ocr-results').innerText = "Scanning...";
        document.getElementById('cam').click();
    },

    process: async function(e) {
        const files = Array.from(e.target.files);
        for (const file of files) {
            const b64 = await this.toB64(file);
            const text = await this.ocr(b64);
            // Perception-only: Split, trim, and append
            const clean = text.split('\n').map(s => s.trim()).filter(s => s);
            this.lines.push(...clean);
            this.render();
        }
        this.save();
    },

    ocr: async function(b64) {
        const key = window.GOOGLE_API_KEY || "YOUR_KEY_IN_RAILWAY_VARS";
        const url = `https://vision.googleapis.com/v1/images:annotate?key=${key}`;
        const res = await fetch(url, {
            method: 'POST',
            body: JSON.stringify({
                requests: [{
                    image: { content: b64.split(',')[1] },
                    features: [{ type: "DOCUMENT_TEXT_DETECTION" }]
                }]
            })
        });
        const json = await res.json();
        return json.responses[0]?.fullTextAnnotation?.text || "";
    },

    render: function() {
        document.getElementById('ocr-results').innerText = this.lines.join('\n');
    },

    save: function() {
        // Create the canonical master file in browser memory
        const master = this.lines.join('\n');
        localStorage.setItem(`source_ocr_${this.projectId}.txt`, master);
        
        // Sync to server backup
        fetch('/api/sync', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id: this.projectId, data: master })
        });
    },

    toB64: f => new Promise(r => {
        const rd = new FileReader();
        rd.onload = () => r(rd.result);
        rd.readAsDataURL(f);
    })
};
</script>
