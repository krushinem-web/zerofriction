<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KrushFlow Inventory</title>
    
    <!-- Google Font - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --brand: #f97316;
            --brand-gradient: linear-gradient(135deg, #f97316 0%, #ef4444 50%, #facc15 100%);
            --glass: rgba(24, 24, 27, 0.7);
            --glass-border: rgba(249, 115, 22, 0.2);
            --zinc-950: #09090b;
            --zinc-900: #18181b;
            --zinc-800: #27272a;
        }

        /* Reset & Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            background-color: var(--zinc-950);
            color: white;
            font-family: 'Inter', -apple-system, sans-serif;
            line-height: 1.5;
            min-height: 100vh;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(249, 115, 22, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 100% 100%, rgba(239, 68, 68, 0.05) 0%, transparent 50%);
        }

        /* Utilities */
        .hidden {
            display: none !important;
            pointer-events: none !important;
            visibility: hidden !important;
            z-index: -1 !important;
        }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .text-center { text-align: center; }

        /* Fiery Glassmorphism */
        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 1.25rem;
            padding: 1.5rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:active {
            transform: scale(0.98);
        }

        /* Gradients */
        .text-fiery {
            background: var(--brand-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }

        .bg-fiery {
            background: var(--brand-gradient);
            border: none;
            color: white;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            width: 100%;
            gap: 0.5rem;
        }

        .btn-primary { background: var(--brand-gradient); color: white; border: none; font-weight: 700; }
        .btn-secondary { background: var(--zinc-800); color: white; border: 1px solid var(--zinc-700); }
        .btn-glass { background: rgba(255,255,255,0.05); color: white; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px); }
        .btn-record { background: #ef4444; color: white; border: none; animation: pulse-red 2s infinite; }
        .btn-record:disabled { background: var(--zinc-800); animation: none; opacity: 0.5; }

        /* Priority Hit Targets - Ensure clickability */
        .btn, .mode-card, .glass-card {
            cursor: pointer !important;
            pointer-events: auto !important;
            position: relative;
            z-index: 10;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* Main Layout */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px 20px 160px 20px; /* Space for fixed controls */
        }

        header {
            padding: 1.25rem 0;
            text-align: center;
        }

        .logo-container {
            min-height: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.25rem;
        }

        .logo-container img {
            max-width: 450px;
            max-height: 180px;
            width: 90%; /* Ensure responsiveness on mobile */
            height: auto;
            /* Enhanced Fiery Glow effect */
            filter: drop-shadow(0 0 15px rgba(249, 115, 22, 0.5));
            transition: transform 0.3s ease;
        }

        .logo-container img:hover {
            transform: scale(1.02);
        }

        /* Grid for Modes */
        .mode-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.25rem;
        }

        @media (min-width: 640px) {
            .mode-grid { grid-template-columns: repeat(3, 1fr); }
        }

        .mode-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 2rem 1.5rem;
            cursor: pointer;
        }

        .mode-card svg {
            width: 48px;
            height: 48px;
            margin-bottom: 1rem;
            color: var(--brand);
        }

        /* Form Elements */
        .upload-zone {
            border: 2px dashed var(--zinc-700);
            border-radius: 1.25rem;
            padding: 2.25rem 1.25rem;
            text-align: center;
            background: rgba(255,255,255,0.02);
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-zone:hover {
            border-color: var(--brand);
            background: rgba(249, 115, 22, 0.05);
        }

        .upload-zone svg {
            width: 56px;
            height: 56px;
        }

        /* Tables & Lists */
        .list-container {
            margin-top: 1.5rem;
            border-radius: 1rem;
            overflow: hidden;
            border: 1px solid var(--zinc-800);
        }

        .list-item {
            padding: 1rem;
            border-bottom: 1px solid var(--zinc-800);
            background: var(--zinc-900);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list-item:last-child { border-bottom: none; }
        .list-item.active { background: rgba(249, 115, 22, 0.1); border-left: 4px solid var(--brand); }

        /* Fixed Controls - 2x2 Grid */
        .fixed-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            box-sizing: border-box;
            background: rgba(9, 9, 11, 0.9);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--zinc-800);
            padding: 12px 12px calc(12px + env(safe-area-inset-bottom));
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            z-index: 1000;
        }
        
        .fixed-controls .btn {
            width: 100%;
            min-width: 0;
            padding: 0.75rem 0.75rem;
            font-size: 0.95rem;
        }

        /* Mobile tightening for fixed controls */
        @media (max-width: 420px) {
            .fixed-controls {
                gap: 8px;
            }
            .fixed-controls .btn {
                font-size: 0.9rem;
                padding: 0.65rem 0.65rem;
            }
            /* Smaller tiles on mobile */
            .upload-zone {
                padding: 1.75rem 1.1rem;
            }
            .upload-zone svg {
                width: 48px;
                height: 48px;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .screen {
            animation: fadeIn 0.4s ease-out forwards;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,255,255,0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Progress */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--zinc-800);
            border-radius: 4px;
            margin: 1rem 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--brand-gradient);
            transition: width 0.5s ease;
        }
    

        /* ============================================ */
        /* COMPREHENSIVE UTILITIES FOR PRODUCTION HTML */
        /* ============================================ */
        
        /* Extended Color Variables */
        :root {
            --zinc-700: #3f3f46;
            --zinc-600: #52525b;
            --zinc-500: #71717a;
            --zinc-400: #a1a1aa;
            --zinc-300: #d4d4d8;
            --zinc-200: #e4e4e7;
            --zinc-100: #f4f4f5;
        }
        
        /* Display & Layout */
        .block { display: block; }
        .inline-block { display: inline-block; }
        .inline-flex { display: inline-flex; }
        .grid { display: grid; }
        .flex-1 { flex: 1 1 0%; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        
        /* Grid */
        .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        @media (min-width: 640px) {
            .sm\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .sm\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        }
        @media (min-width: 768px) {
            .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .md\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        }
        
        /* Padding */
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .p-8 { padding: 2rem; }
        .p-12 { padding: 3rem; }
        .p-16 { padding: 4rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        
        /* Margin */
        .m-0 { margin: 0; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mb-12 { margin-bottom: 3rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .mx-4 { margin-left: 1rem; margin-right: 1rem; }
        .my-6 { margin-top: 1.5rem; margin-bottom: 1.5rem; }
        .ml-3 { margin-left: 0.75rem; }
        
        /* Icon Container Centering */
        .icon-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Width & Height */
        .w-5 { width: 1.25rem; }
        .w-6 { width: 1.5rem; }
        .w-7 { width: 1.75rem; }
        .w-8 { width: 2rem; }
        .w-10 { width: 2.5rem; }
        .w-16 { width: 4rem; }
        .w-20 { width: 5rem; }
        .w-full { width: 100%; }
        .h-3 { height: 0.75rem; }
        .h-5 { height: 1.25rem; }
        .h-6 { height: 1.5rem; }
        .h-7 { height: 1.75rem; }
        .h-8 { height: 2rem; }
        .h-10 { height: 2.5rem; }
        .h-16 { height: 4rem; }
        .max-h-96 { max-height: 24rem; }
        .max-w-md { max-width: 28rem; }
        .max-w-6xl { max-width: 72rem; }
        .min-h-screen { min-height: 100vh; }
        
        /* Colors - Text */
        .text-white { color: white; }
        .text-zinc-100 { color: var(--zinc-100); }
        .text-zinc-200 { color: var(--zinc-200); }
        .text-zinc-300 { color: var(--zinc-300); }
        .text-zinc-400 { color: var(--zinc-400); }
        .text-zinc-500 { color: var(--zinc-500); }
        .text-zinc-600 { color: var(--zinc-600); }
        .text-orange-200 { color: #fed7aa; }
        .text-orange-300 { color: #fdba74; }
        .text-orange-400 { color: var(--brand); }
        .text-orange-600 { color: #ea580c; }
        .text-red-400 { color: #f87171; }
        .text-yellow-400 { color: #facc15; }
        .text-green-400 { color: #4ade80; }
        .text-indigo-100 { color: #e0e7ff; }
        .text-indigo-200 { color: #c7d2fe; }
        .text-indigo-300 { color: #a5b4fc; }
        
        /* Colors - Background */
        .bg-zinc-700 { background-color: var(--zinc-700); }
        .bg-zinc-800 { background-color: var(--zinc-800); }
        .bg-zinc-900 { background-color: var(--zinc-900); }
        .bg-zinc-800\/50 { background-color: rgba(39, 39, 42, 0.5); }
        .bg-orange-500\/10 { background-color: rgba(249, 115, 22, 0.1); }
        .bg-orange-600 { background-color: #ea580c; }
        .bg-indigo-500\/10 { background-color: rgba(99, 102, 241, 0.1); }
        .bg-indigo-600 { background-color: #4f46e5; }
        .bg-red-500\/10 { background-color: rgba(239, 68, 68, 0.1); }
        .bg-red-500\/20 { background-color: rgba(239, 68, 68, 0.2); }
        .bg-red-600 { background-color: #dc2626; }
        .bg-green-500\/10 { background-color: rgba(34, 197, 94, 0.1); }
        .bg-yellow-500\/20 { background-color: rgba(234, 179, 8, 0.2); }
        
        /* Borders */
        .border { border-width: 1px; }
        .border-2 { border-width: 2px; }
        .border-dashed { border-style: dashed; }
        .border-zinc-700 { border-color: var(--zinc-700); }
        .border-zinc-800 { border-color: var(--zinc-800); }
        .border-orange-500\/30 { border-color: rgba(249, 115, 22, 0.3); }
        .border-orange-700\/50 { border-color: rgba(194, 65, 12, 0.5); }
        .border-indigo-500\/30 { border-color: rgba(99, 102, 241, 0.3); }
        .border-indigo-700\/50 { border-color: rgba(67, 56, 202, 0.5); }
        .border-red-500\/50 { border-color: rgba(239, 68, 68, 0.5); }
        .border-green-500\/50 { border-color: rgba(34, 197, 94, 0.5); }
        .border-emerald-700\/50 { border-color: rgba(4, 120, 87, 0.5); }
        
        /* Border Radius */
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-2xl { border-radius: 1rem; }
        .rounded-full { border-radius: 9999px; }
        
        /* Typography */
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .text-3xl { font-size: 1.875rem; line-height: 2.25rem; }
        .text-5xl { font-size: 3rem; line-height: 1; }
        .text-6xl { font-size: 3.75rem; line-height: 1; }
        .font-light { font-weight: 300; }
        .font-normal { font-weight: 400; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .font-extrabold { font-weight: 800; }
        .leading-none { line-height: 1; }
        .leading-relaxed { line-height: 1.625; }
        
        /* Overflow */
        .overflow-hidden { overflow: hidden; }
        .overflow-y-auto { overflow-y: auto; }
        
        /* Transitions */
        .transition-all { transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1); }
        .transition-colors { transition-property: color, background-color, border-color; }
        .transition-transform { transition-property: transform; }
        .duration-300 { transition-duration: 300ms; }
        .duration-500 { transition-duration: 500ms; }
        
        /* Hover States */
        .hover\:bg-zinc-600:hover { background-color: var(--zinc-600); }
        .hover\:bg-zinc-700:hover { background-color: var(--zinc-700); }
        .hover\:bg-zinc-800\/50:hover { background-color: rgba(39, 39, 42, 0.5); }
        .hover\:bg-orange-500:hover { background-color: var(--brand); }
        .hover\:bg-indigo-500:hover { background-color: #6366f1; }
        .hover\:bg-red-500:hover { background-color: #ef4444; }
        .hover\:bg-red-500\/30:hover { background-color: rgba(239, 68, 68, 0.3); }
        .hover\:border-orange-500:hover { border-color: var(--brand); }
        .hover\:border-red-500:hover { border-color: #ef4444; }
        .hover\:border-purple-500:hover { border-color: #a855f7; }
        .hover\:border-pink-500:hover { border-color: #ec4899; }
        .hover\:border-emerald-500:hover { border-color: #10b981; }
        .hover\:text-white:hover { color: white; }
        .hover\:shadow-2xl:hover { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .hover\:shadow-orange-500\/20:hover { box-shadow: 0 25px 50px -12px rgba(249, 115, 22, 0.2); }
        .hover\:shadow-orange-500\/50:hover { box-shadow: 0 25px 50px -12px rgba(249, 115, 22, 0.5); }
        .hover\:-translate-y-1:hover { transform: translateY(-0.25rem); }
        
        /* Focus */
        .focus\:outline-none:focus { outline: 2px solid transparent; outline-offset: 2px; }
        .focus\:border-orange-500:focus { border-color: var(--brand); }
        .focus\:border-indigo-500:focus { border-color: #6366f1; }
        
        /* Disabled */
        .disabled\:opacity-50:disabled { opacity: 0.5; }
        .disabled\:cursor-not-allowed:disabled { cursor: not-allowed; }
        
        /* Group Hover */
        .group:hover .group-hover\:scale-110 { transform: scale(1.1); }
        
        /* Misc */
        .cursor-pointer { cursor: pointer; }
        .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .space-y-3 > * + * { margin-top: 0.75rem; }
        .divide-y > * + * { border-top-width: 1px; }
        .divide-zinc-800 > * + * { border-color: var(--zinc-800); }
        .animate-slide-down { animation: fadeIn 0.3s ease; }




        /* Missing Utility Classes */
        .gradient-primary {
            background: var(--brand-gradient);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4);
        }
        
        .gradient-success {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse-border {
            0%, 100% {
                border-color: rgb(99 102 241);
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
            }
            50% {
                border-color: rgb(139 92 246);
                box-shadow: 0 0 0 8px rgba(139, 92, 246, 0);
            }
        }
        
        .animate-slide-down { animation: slideDown 0.3s ease; }
        .pulse-border { animation: pulse-border 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .glass {
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        /* ============================================ */
        /* AGGRESSIVE MIC OVERLAY (FIRE PALETTE)       */
        /* ============================================ */
        .mic-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.92);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            touch-action: none;
        }

        .mic-overlay.hidden { display: none; }

        /* Overlay Reactivation - Ensure active overlay works */
        .mic-overlay:not(.hidden) {
            display: flex !important;
            pointer-events: auto !important;
            visibility: visible !important;
            z-index: 9999 !important;
        }

        .mic-pulse {
            position: relative;
            width: 150px;
            height: 150px;
            --pulseScale: 1;
        }

        .mic-core {
            position: absolute;
            inset: 0;
            margin: auto;
            width: 76px;
            height: 76px;
            border-radius: 50%;
            background: radial-gradient(circle,
                #FFB300 0%,
                #FF6A00 45%,
                #D62828 78%
            );
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            color: #000;
            box-shadow:
                0 0 22px rgba(255,106,0,0.95),
                0 0 48px rgba(214,40,40,0.9);
            transform: scale(var(--pulseScale));
            transition: transform 80ms linear;
            z-index: 2;
            cursor: pointer;
        }

        .ring {
            position: absolute;
            inset: 0;
            margin: auto;
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 2px solid rgba(255,106,0,0.7);
            animation: pulse 1.15s cubic-bezier(.2,.7,.2,1) infinite;
            filter: drop-shadow(0 0 10px rgba(255,106,0,0.5));
        }

        .ring-2 {
            animation-delay: 0.25s;
            border-color: rgba(255,179,0,0.6);
        }

        .ring-3 {
            animation-delay: 0.50s;
            border-color: rgba(214,40,40,0.6);
        }

        @keyframes pulse {
            0%   { transform: scale(0.55); opacity: 0.95; }
            70%  { opacity: 0.25; }
            100% { transform: scale(1.95); opacity: 0; }
        }

        .mic-label {
            margin-top: 26px;
            font-size: 16px;
            color: #FFB300;
            letter-spacing: 0.6px;
            text-transform: none;
        }

</style>

</head>
<body>
    <div class="max-w-6xl mx-auto px-4 py-8">
        
        <!-- Micro-banner for closure/success messages -->
        <div id="microBanner" class="hidden animate-slide-down mb-6" style="position: relative; z-index: 9999;">
            <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-4 flex items-center justify-between shadow-2xl">
                <div class="flex items-center gap-3">
                    <div id="microBannerIcon" class="w-10 h-10 rounded-lg flex items-center justify-center"></div>
                    <div id="microBannerContent" class="text-zinc-100 font-medium"></div>
                </div>
                <button onclick="hideMicroBanner()" class="text-zinc-400 hover:text-white transition-colors text-2xl leading-none">√ó</button>
            </div>
        </div>
        
        <!-- Header -->
        <div class="text-center mb-4" style="background: transparent !important;">
            <img src="logo.png" alt="KrushFlow" class="mx-auto mb-1" style="width: 100%; max-width: 600px; height: auto; object-fit: contain;">
            <p class="text-zinc-400 text-lg font-light" style="font-weight: 300; margin-bottom: 0;">Intelligent inventory management</p>
        </div>

        <!-- Mode Selection Screen -->
        <div id="modeSelectionScreen" class="transition-all duration-500">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- New Setup Mode -->
                <div onclick="selectMode('new-setup')" class="group cursor-pointer">
                    <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-8 transition-all duration-300 hover:border-orange-500 hover:shadow-2xl hover:shadow-orange-500/20 hover:-translate-y-1">
                        <div class="icon-container text-6xl mb-6 transition-transform group-hover:scale-110">
                            <svg class="w-16 h-16 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-2xl text-white mb-3" style="font-weight: 700;">New Setup</h3>
                        <p class="text-zinc-400 leading-relaxed font-normal" style="font-weight: 400;">Upload prep sheet images to create your master inventory list</p>
                    </div>
                </div>

                <!-- Voice Mapping Mode -->
                <div onclick="selectMode('voice-mapping')" class="group cursor-pointer">
                    <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-8 transition-all duration-300 hover:border-orange-500 hover:shadow-2xl hover:shadow-orange-500/20 hover:-translate-y-1">
                        <div class="icon-container text-6xl mb-6 transition-transform group-hover:scale-110">
                            <svg class="w-16 h-16 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                            </svg>
                        </div>
                        <h3 class="text-2xl text-white mb-3" style="font-weight: 700;">Voice Mapping</h3>
                        <p class="text-zinc-400 leading-relaxed font-normal" style="font-weight: 400;">Record voice aliases for items to improve recognition accuracy</p>
                    </div>
                </div>

                <!-- Daily Count Mode -->
                <div onclick="selectMode('daily-count')" class="group cursor-pointer">
                    <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-8 transition-all duration-300 hover:border-orange-500 hover:shadow-2xl hover:shadow-orange-500/20 hover:-translate-y-1">
                        <div class="icon-container text-6xl mb-6 transition-transform group-hover:scale-110">
                            <svg class="w-16 h-16 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <h3 class="text-2xl text-white mb-3" style="font-weight: 700;">Daily Count</h3>
                        <p class="text-zinc-400 leading-relaxed font-normal" style="font-weight: 400;">Use voice commands to count inventory quickly and accurately</p>
                    </div>
                </div>
            </div>
            
            <p id="lastRunText" class="text-center text-zinc-500 text-sm"></p>
        </div>

        <!-- New Setup Mode -->
        <div id="newSetupScreen" class="hidden transition-all duration-500">
            <button onclick="showModeSelection()" class="btn btn-secondary mb-6" style="width: auto;">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Back to Mode Selection
            </button>
            
            <div class="glass-card mb-6">
                <!-- Upload Options -->
                <div class="text-center mb-6">
                    <h3 class="text-2xl text-white mb-3" style="font-weight: 600;">Add Images to Parse</h3>
                    <p class="text-zinc-400 font-normal mb-6" style="font-weight: 400;">Supports JPEG, PNG, WEBP ‚Ä¢ Max 8MB per image ‚Ä¢ Up to 30 images</p>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="document.getElementById('fileInputCamera').click()" class="glass-card p-6 hover:bg-zinc-800/50 transition-all duration-300 cursor-pointer">
                            <svg class="w-12 h-12 mx-auto mb-3 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <p class="text-white font-semibold">üì∑ Use Camera</p>
                        </button>
                        
                        <button onclick="document.getElementById('fileInputGallery').click()" class="glass-card p-6 hover:bg-zinc-800/50 transition-all duration-300 cursor-pointer">
                            <svg class="w-12 h-12 mx-auto mb-3 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <p class="text-white font-semibold">üñºÔ∏è Choose Files</p>
                        </button>
                    </div>
                </div>
                
                <input type="file" id="fileInputCamera" accept="image/*" capture="environment" multiple class="hidden">
                <input type="file" id="fileInputGallery" accept="image/jpeg,image/png,image/webp" multiple class="hidden">
                
                <!-- File List -->
                <div id="fileList" class="hidden mt-6 space-y-3"></div>
                
                <!-- Parse Button -->
                <button id="parseButton" disabled class="btn btn-primary hover:shadow-2xl hover:shadow-orange-500/50">
                    <span id="parseButtonText" class="flex items-center justify-center gap-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        Parse Inventory
                    </span>
                </button>
                
                <div id="error" class="hidden mt-4 p-4 bg-red-500/10 border border-red-500/50 rounded-xl text-red-400"></div>
            </div>

            <!-- Loading Section -->
            <div id="loadingSection" class="hidden bg-zinc-900 border border-zinc-800 rounded-2xl p-16 text-center">
                <div class="spinner mx-auto mb-6"></div>
                <p class="text-zinc-400 text-lg">Analyzing images with AI...</p>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="gradient-primary rounded-2xl p-8 text-center">
                        <div id="itemCount" class="text-6xl font-bold mb-2">0</div>
                        <div class="text-orange-200 text-lg font-medium">Unique Items</div>
                    </div>
                    <div class="gradient-primary rounded-2xl p-8 text-center">
                        <div id="imageCount" class="text-6xl font-bold mb-2">0</div>
                        <div class="text-orange-200 text-lg font-medium">Images Processed</div>
                    </div>
                </div>

                <div class="glass-card">
                    <h2 class="text-2xl font-bold mb-6 flex items-center gap-3">
                        <svg class="w-7 h-7 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Extracted Items
                    </h2>
                    <!-- Scrollable card list -->
                    <div id="itemsScrollContainer" class="list-container" style="max-height: 60vh; overflow-y: auto; padding: 1rem; gap: 0.75rem; display: flex; flex-direction: column;">
                        <!-- Items will be rendered here as cards -->
                    </div>
                    
                    <!-- Project Save Controls -->
                    <div id="projectSaveControls" class="mt-6 p-4 bg-zinc-800/40 rounded-xl border border-zinc-700">
                        <label class="block text-sm font-medium text-zinc-300 mb-2">Project Name (required to save)</label>
                        <input 
                            id="projectNameInput" 
                            type="text" 
                            placeholder="e.g., Main Kitchen Inventory" 
                            class="w-full px-4 py-3 bg-zinc-900 border border-zinc-700 rounded-lg text-white focus:border-orange-500 focus:outline-none mb-3"
                        />
                        <div class="flex gap-3">
                            <button id="saveListButton" class="btn btn-primary flex-1">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                                </svg>
                                Save List (Server)
                            </button>
                            <button id="continueToVoiceMappingButton" class="btn btn-glass flex-1" disabled>
                                Continue to Voice Mapping ‚Üí
                            </button>
                        </div>
                        <div id="saveStatus" class="hidden mt-3 p-3 rounded-lg text-sm"></div>
                    </div>
                    
                    <div class="flex gap-4 mt-4">
                        <button id="downloadButton" class="btn btn-secondary flex items-center justify-center gap-3">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            Download CSV
                        </button>
                        <button id="downloadJsonButton" class="btn btn-secondary flex items-center justify-center gap-3">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            Download JSON
                        </button>
                    </div>
                    <p class="text-xs text-zinc-500 mt-2">Optional: Download list before or after saving to server</p>
                </div>
            </div>
        </div>

        <!-- Voice Mapping Mode -->
        <div id="voiceMappingScreen" class="hidden transition-all duration-500">
            <button onclick="showModeSelection()" class="btn btn-secondary mb-6" style="width: auto;">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Back to Mode Selection
            </button>
            
            <!-- Voice Setup Choice -->
            <div id="voiceSetupChoice" class="glass-card">
                <h2 class="text-3xl font-bold mb-4 flex items-center gap-3">
                    <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                    </svg>
                    Voice Mapping Setup
                </h2>
                
                <!-- Master Alias Status -->
                <div id="masterAliasStatus" class="hidden bg-indigo-500/10 border border-indigo-500/30 rounded-xl p-4 mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-semibold text-orange-300 mb-1">Master Aliases Loaded</div>
                            <div class="text-sm text-zinc-400" id="aliasFilenameDisplay"></div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="replaceAliasFile()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-sm font-medium transition-colors">Replace</button>
                            <button onclick="clearAliasFile()" class="px-4 py-2 bg-zinc-700 hover:bg-zinc-600 rounded-lg text-sm font-medium transition-colors">Clear</button>
                        </div>
                    </div>
                </div>
                
                <!-- OPTION A: Active List Status -->
                <div id="activeListStatus" class="hidden bg-orange-500/10 border border-orange-500/30 rounded-xl p-4 mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-semibold text-orange-300 mb-1">Active Inventory List</div>
                            <div class="text-sm text-zinc-400" id="activeListNameDisplay"></div>
                            <div class="text-xs text-zinc-500 mt-1" id="activeListUpdatedDisplay"></div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="clearActiveListAndReparse()" class="px-4 py-2 bg-orange-600 hover:bg-orange-500 rounded-lg text-sm font-medium transition-colors">Create New List</button>
                        </div>
                    </div>
                </div>

                <p class="text-zinc-400 mb-8 leading-relaxed">
                    This optional setup helps improve voice recognition. You can load a saved project list from the server,
                    upload an inventory file from your device, upload new prep sheet images, or continue with a previously saved alias file.
                </p>
                
                <!-- NEW: Load List from Server -->
                <div id="serverListLoader" class="bg-blue-500/10 border border-blue-500/30 rounded-xl p-6 mb-6">
                    <h3 class="text-xl font-semibold text-white mb-4 flex items-center gap-2">
                        <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path>
                        </svg>
                        Load List from Server
                    </h3>
                    <p class="text-zinc-400 text-sm mb-4">Load a previously saved project list from the server</p>
                    <div class="flex gap-3">
                        <input 
                            id="serverProjectNameInput" 
                            type="text" 
                            placeholder="Enter project name" 
                            class="flex-1 px-4 py-3 bg-zinc-900 border border-zinc-700 rounded-lg text-white focus:border-blue-500 focus:outline-none"
                        />
                        <button id="loadFromServerButton" class="btn btn-primary" style="width: auto; padding: 0.75rem 1.5rem;">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                            </svg>
                            Load from Server
                        </button>
                    </div>
                    <div id="serverLoadStatus" class="hidden mt-3 p-3 rounded-lg text-sm"></div>
                </div>
                
                <div class="text-center text-zinc-600 font-bold my-6">- OR -</div>

                <!-- OPTION A: Image Upload Section (hidden when active list exists) -->
                <div id="voiceImageUploadSection">
                    <!-- Upload New Images -->
                    <div class="text-center mb-6">
                        <h3 class="text-xl font-semibold text-white mb-2">Add Images for Voice Mapping</h3>
                    <p class="text-zinc-400 text-sm mb-6">Supports JPEG, PNG, WEBP ‚Ä¢ Max 8MB per image ‚Ä¢ Up to 30 images</p>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="document.getElementById('voiceFileInputCamera').click()" class="glass-card p-6 hover:bg-zinc-800/50 transition-all duration-300 cursor-pointer">
                            <svg class="w-12 h-12 mx-auto mb-3 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <p class="text-white font-semibold">üì∑ Use Camera</p>
                        </button>
                        
                        <button onclick="document.getElementById('voiceFileInputGallery').click()" class="glass-card p-6 hover:bg-zinc-800/50 transition-all duration-300 cursor-pointer">
                            <svg class="w-12 h-12 mx-auto mb-3 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <p class="text-white font-semibold">üñºÔ∏è Choose Files</p>
                        </button>
                    </div>
                </div>
                
                <input type="file" id="voiceFileInputCamera" accept="image/*" capture="environment" multiple class="hidden">
                <input type="file" id="voiceFileInputGallery" accept="image/jpeg,image/png,image/webp" multiple class="hidden">
                
                <div id="voiceFileList" class="hidden mb-6 space-y-3"></div>
                
                    <button id="voiceParseButton" disabled class="w-full py-4 rounded-xl font-bold text-lg transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed gradient-primary hover:shadow-2xl hover:shadow-red-500/50 mb-6">
                        Parse Images for Voice Mapping
                    </button>

                    <div class="text-center text-zinc-600 font-bold my-6">- OR -</div>
                </div>
                <!-- End OPTION A: Image Upload Section -->

                <!-- Load Inventory File -->
                <div id="inventoryFileZone" class="border-2 border-dashed border-emerald-700/50 rounded-xl p-12 text-center cursor-pointer transition-all duration-300 hover:border-emerald-500 hover:bg-zinc-800/50 mb-6">
                    <svg class="w-16 h-16 mx-auto mb-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <h3 class="text-xl font-semibold text-white mb-2">Load Existing Inventory List</h3>
                    <p class="text-zinc-400 text-sm">Upload your inventory_list.csv or .txt file</p>
                </div>
                <input type="file" id="inventoryFileInput" accept=".csv,.txt" class="hidden">

                <div class="text-center text-zinc-600 font-bold my-6">- OR -</div>

                <!-- Load Alias File -->
                <div id="aliasFileZone" class="border-2 border-dashed border-indigo-700/50 rounded-xl p-12 text-center cursor-pointer transition-all duration-300 hover:border-indigo-500 hover:bg-zinc-800/50">
                    <svg class="w-16 h-16 mx-auto mb-4 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                    </svg>
                    <h3 class="text-xl font-semibold text-white mb-2">Load Existing Master Alias File</h3>
                    <p class="text-zinc-400 text-sm">Continue mapping where you left off (inventory_aliases_*.csv)</p>
                </div>
                <input type="file" id="aliasFileInput" accept=".csv" class="hidden">

                
                <!-- REMOVED: Load KrushProfile UI (now always-on server-side) -->


                <div id="voiceSetupError" class="hidden mt-6 p-4 bg-red-500/10 border border-red-500/50 rounded-xl text-red-400"></div>
            </div>

            <!-- Voice Loading Section -->
            <div id="voiceLoadingSection" class="hidden bg-zinc-900 border border-zinc-800 rounded-2xl p-16 text-center">
                <div class="spinner mx-auto mb-6"></div>
                <p class="text-zinc-400 text-lg">Processing images with AI...</p>
            </div>

            <!-- Voice Mapping Interface -->
            <div id="voiceMappingInterface" class="hidden glass-card">
                <h2 class="text-3xl font-bold mb-6 flex items-center gap-3">
                    <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                    </svg>
                    Record Voice Aliases
                </h2>
                
                <!-- Progress Bar -->
                <div class="bg-zinc-800 h-3 rounded-full overflow-hidden mb-2">
                    <div id="mappingProgress" class="gradient-primary h-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <div id="mappingProgressText" class="text-zinc-400 font-semibold text-center mb-6"></div>

                <!-- Voice Status -->
                <div id="voiceStatus">
                    <h4 class="text-xl font-semibold mb-2">Select an item to begin</h4>
                    <p class="text-zinc-400">Click any item below, then press "Record Voice Alias"</p>
                </div>

                <!-- Voice Controls -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <button id="recordButton" disabled class="btn btn-record flex items-center justify-center gap-2" style="height: 48px; padding: 0.5rem 1rem; font-size: 0.95rem;">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                        </svg>
                        <span id="recordButtonText">Record Voice Alias</span>
                    </button>
                    <button id="skipButton" onclick="skipCurrentItem()" class="rounded-xl font-semibold transition-all duration-300 flex items-center justify-center gap-2 bg-zinc-700" style="height: 48px; padding: 0.5rem 1rem; font-size: 0.95rem;">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
                        </svg>
                        Skip Item
                    </button>
                </div>

                <!-- Current Phrases -->
                <div id="currentPhrases" class="hidden bg-indigo-500/10 border border-indigo-500/30 rounded-xl p-6 mb-6">
                    <h4 class="font-semibold text-orange-300 mb-4">Recorded phrases for this item:</h4>
                    <div id="phraseList" class="space-y-2"></div>
                </div>

                <!-- Inventory List -->
                <div class="list-container mb-6 max-h-96 overflow-y-auto">
                    <div id="inventoryList"></div>
                </div>

                <button id="finishMappingButton" class="btn bg-fiery hover:shadow-2xl hover:shadow-green-500/50 flex items-center justify-center gap-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Finish & Download Aliases
                </button>

                <div id="voiceError" class="hidden mt-6 p-4 bg-red-500/10 border border-red-500/50 rounded-xl text-red-400"></div>
                <div id="voiceSuccess" class="hidden mt-6 p-4 bg-green-500/10 border border-green-500/50 rounded-xl text-green-400"></div>
            </div>
        </div>

        <!-- Daily Count Mode -->
        <div id="dailyCountScreen" class="hidden transition-all duration-500">
            <button onclick="showModeSelection()" class="btn btn-secondary mb-6" style="width: auto;">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Back to Mode Selection
            </button>
            
            <!-- Setup Choice -->
            <div id="dailyCountSetup" class="glass-card">
                <h2 class="text-3xl font-bold mb-4 flex items-center gap-3">
                    <svg class="w-8 h-8 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Daily Count Setup
                </h2>
                
                <p class="text-zinc-400 mb-8 leading-relaxed">
                    Load your inventory list and alias mappings to begin voice-powered counting.
                </p>

                <!-- Load Inventory File -->
                <div id="dailyCountInventoryZone" class="upload-zone mb-6">
                    <svg class="w-16 h-16 mx-auto mb-4 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <h3 class="text-xl font-semibold text-white mb-2">Load Inventory List</h3>
                    <p class="text-zinc-400 text-sm">Upload your inventory_list.csv file</p>
                </div>
                <input type="file" id="dailyCountInventoryInput" accept=".csv,.txt" class="hidden">

                <div class="text-center text-zinc-600 font-bold my-6">AND</div>

                <!-- Load Alias File -->
                <div id="dailyCountAliasZone" class="upload-zone">
                    <svg class="w-16 h-16 mx-auto mb-4 text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                    </svg>
                    <h3 class="text-xl font-semibold text-white mb-2">Load Alias Mappings</h3>
                    <p class="text-zinc-400 text-sm">Upload your inventory_aliases_*.csv file</p>
                </div>
                <input type="file" id="dailyCountAliasInput" accept=".csv" class="hidden">

                <!-- REMOVED: Load KrushProfile UI (now always-on server-side) -->

                <div id="dailyCountSetupStatus" class="hidden bg-indigo-500/10 border border-indigo-500/30 rounded-xl p-4 mt-6">
                    <div class="text-sm text-zinc-300">
                        <div id="dailyCountInventoryStatus" class="hidden mb-2">‚úì Inventory loaded: <span class="font-semibold" id="dailyCountInventoryCount"></span> items</div>
                        <div id="dailyCountAliasStatus" class="hidden">‚úì Aliases loaded: <span class="font-semibold" id="dailyCountAliasCount"></span> mappings</div>
                    </div>
                </div>

                <button id="startCountButton" disabled class="btn btn-primary hover:shadow-2xl hover:shadow-yellow-400/50" style="margin-bottom: 2rem;">
                    Start Counting
                </button>

                <div id="dailyCountSetupError" class="hidden mt-6 p-4 bg-red-500/10 border border-red-500/50 rounded-xl text-red-400"></div>
            </div>

<!-- Counting Interface -->
            <div id="dailyCountInterface" class="hidden glass-card" style="padding-bottom: 140px;">
                <h2 class="text-3xl font-bold mb-6 flex items-center gap-3">
                    <svg class="w-8 h-8 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    Daily Count Active
                    <span id="apiStatusIndicator" class="w-3 h-3 rounded-full bg-green-500 transition-colors duration-300" title="API Status: Ready"></span>
                </h2>

                <!-- Progress Bar -->
                <div class="bg-zinc-800 h-3 rounded-full overflow-hidden mb-2">
                    <div id="countProgress" class="gradient-primary h-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <div id="countProgressText" class="text-zinc-400 font-semibold text-center mb-6">0 of 0 items counted</div>

                <!-- Voice Status -->
                <div id="dailyCountStatus">
                    <h4 class="text-xl font-semibold mb-2">Press "Record" to count items</h4>
                    <p class="text-zinc-400">Say something like: "ribeyes twelve" or "we have 5 sirloins"</p>
                </div>

                <!-- Voice Controls (Fixed on Mobile) - 2x2 Grid -->
                <div id="voiceControlsContainer" class="fixed-controls">
                    <button id="dailyRecordButton" class="btn btn-record">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                        </svg>
                        <span id="dailyRecordButtonText">Record</span>
                    </button>
                    <button id="undoButton" onclick="undoLastCommand()" class="btn btn-glass">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                        </svg>
                        Undo
                    </button>
                    <button id="finishCountButton" onclick="finishCount()" class="btn btn-glass">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Finish
                    </button>
                    <button id="downloadCountButton" onclick="finishCount()" class="btn btn-glass">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        Download
                    </button>
                    <button id="importExcelButton" onclick="openExcelImportModal()" class="btn btn-glass">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        Import Excel
                    </button>
                </div>


                <!-- Scrollable Inventory List with Counts -->
                <div class="list-container mb-6 max-h-96 overflow-y-auto">
                    <div id="dailyInventoryList"></div>
                </div>

                <!-- Auto-Match Confirmation (Medium Confidence) -->
                <div id="autoMatchSection" class="hidden bg-orange-500/10 border border-orange-500/30 rounded-xl p-6 mb-6">
                    <h3 class="font-bold text-lg mb-4 text-orange-400 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Auto-Match Confirmation Needed
                    </h3>
                    <p class="text-sm text-zinc-400 mb-4">These items were matched with medium confidence. Confirm or reject each match:</p>
                    <div id="autoMatchList" class="space-y-3"></div>
                </div>

                <!-- Unmapped Commands -->
                <div id="unmappedSection" class="hidden bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-6 mb-6">
                    <h3 class="font-bold text-lg mb-4 text-yellow-400">Unmapped Commands</h3>
                    <div id="unmappedList" class="space-y-2 text-sm"></div>
                </div>

                <!-- Action Buttons removed - using fixed bottom controls instead -->

                <div id="dailyCountError" class="hidden mt-6 p-4 bg-red-500/10 border border-red-500/50 rounded-xl text-red-400"></div>
            </div>
        </div>

        <!-- Excel Import Modal -->
        <div id="excelImportModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
            <div class="glass-card max-w-md w-full">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-2xl font-bold">Import Excel</h3>
                    <button onclick="closeExcelImportModal()" class="text-zinc-400 hover:text-white transition-colors text-2xl leading-none">√ó</button>
                </div>
                <p class="text-zinc-400 mb-4">Upload an Excel file to import counts. Only counts will be imported; master list cannot be edited.</p>
                
                <input type="file" id="excelFileInput" accept=".xlsx,.xls" class="hidden" onchange="handleExcelFile(event)">
                <button onclick="document.getElementById('excelFileInput').click()" class="btn btn-primary w-full mb-4">
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    Choose Excel File
                </button>
                
                <div id="excelColumnSelector" class="hidden">
                    <p class="text-zinc-400 text-sm mb-3">Select which columns contain your data:</p>
                    <div class="space-y-3">
                        <div>
                            <label class="text-zinc-300 text-sm block mb-1">Item Name Column:</label>
                            <select id="itemColumnSelect" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-2 text-white focus:border-orange-500 focus:outline-none">
                            </select>
                        </div>
                        <div>
                            <label class="text-zinc-300 text-sm block mb-1">Count Column:</label>
                            <select id="countColumnSelect" class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-2 text-white focus:border-orange-500 focus:outline-none">
                            </select>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-4">
                        <button onclick="processExcelImport()" class="btn btn-primary flex-1">Import Counts</button>
                        <button onclick="closeExcelImportModal()" class="btn btn-glass">Cancel</button>
                    </div>
                </div>
                
                <div id="excelImportStatus" class="hidden mt-3 p-3 rounded-lg text-sm"></div>
            </div>
        </div>

        <!-- Feedback Modal -->
        <div id="feedbackModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
            <div class="glass-card max-w-md w-full">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-2xl font-bold">Send Feedback</h3>
                    <button onclick="closeFeedbackModal()" class="text-zinc-400 hover:text-white transition-colors text-2xl leading-none">√ó</button>
                </div>
                <p class="text-zinc-400 mb-4">Help us improve KrushFlow! Share your thoughts, report issues, or suggest features.</p>
                <textarea id="feedbackText" class="w-full h-32 bg-zinc-800 border border-zinc-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none resize-none" placeholder="Your feedback..."></textarea>
                <div class="flex gap-3 mt-4">
                    <button onclick="submitFeedback()" class="btn btn-primary flex-1">Send Feedback</button>
                    <button onclick="closeFeedbackModal()" class="btn btn-glass">Cancel</button>
                </div>
                <div id="feedbackStatus" class="hidden mt-3 p-3 rounded-lg text-sm"></div>
            </div>
        </div>

    </div>

    <!-- Microphone Recording Overlay (AGGRESSIVE FIRE-THEMED) -->
    <div id="microphoneOverlay" class="mic-overlay hidden" aria-hidden="true">
        <div class="mic-pulse" id="micPulse">
            <div class="ring ring-1"></div>
            <div class="ring ring-2"></div>
            <div class="ring ring-3"></div>
            <div class="mic-core" id="micCore">üé§</div>
        </div>
        <div class="mic-label" id="micLabel">Listening‚Ä¶</div>
    </div>

    <script>
        // ============================================
        // SCROLL-TO-TOP FIX
        // ============================================
        // Force page to load at top (prevents mid-page loading)
        (function () {
            const goTop = () => window.scrollTo({ top: 0, left: 0, behavior: "auto" });

            // Prevent browser from restoring scroll position automatically
            if ("scrollRestoration" in history) history.scrollRestoration = "manual";

            // Initial load
            if (document.readyState === "complete" || document.readyState === "interactive") {
                goTop();
            } else {
                document.addEventListener("DOMContentLoaded", goTop, { once: true });
            }

            // When returning via back/forward cache (Safari/Chrome)
            window.addEventListener("pageshow", (e) => {
                if (e.persisted) goTop();
            });
        })();

        // ============================================
        // LOCALSTORAGE KEYS
        // ============================================
        // localStorage keys for master alias persistence
        const LS_ALIAS_CSV_KEY = "zf_master_alias_csv_v1";
        const LS_ALIAS_FILENAME_KEY = "zf_master_alias_filename_v1";
        const LS_ALIAS_LOADED_AT_KEY = "zf_master_alias_loaded_at_v1";
        
        // Active List State (Option A - Single Source of Truth)
        const LS_ACTIVE_LIST_ID = "zf_active_list_id_v1";
        const LS_ACTIVE_LIST_NAME = "zf_active_list_name_v1";
        const LS_ACTIVE_LIST_ITEMS = "zf_active_list_items_v1";
        const LS_ACTIVE_LIST_UPDATED_AT = "zf_active_list_updated_at_v1";
        const LS_ACTIVE_LIST_SOURCE = "zf_active_list_source_v1";
        const LS_LAST_INVENTORY_RUN_KEY = "zf_last_inventory_run_v1";

        // ============================================
        // ACTIVE LIST STATE MANAGEMENT (OPTION A)
        // ============================================
        // Single source of truth for the active inventory list
        
        function saveActiveList(scanId, listName, items, source = 'new_project_parse') {
            const timestamp = new Date().toISOString();
            localStorage.setItem(LS_ACTIVE_LIST_ID, scanId);
            localStorage.setItem(LS_ACTIVE_LIST_NAME, listName);
            localStorage.setItem(LS_ACTIVE_LIST_ITEMS, JSON.stringify(items));
            localStorage.setItem(LS_ACTIVE_LIST_UPDATED_AT, timestamp);
            localStorage.setItem(LS_ACTIVE_LIST_SOURCE, source);
            console.log(`[Active List] Saved: ${listName} (${items.length} items) from ${source}`);
        }
        
        function getActiveList() {
            const listId = localStorage.getItem(LS_ACTIVE_LIST_ID);
            if (!listId) return null;
            
            try {
                const items = JSON.parse(localStorage.getItem(LS_ACTIVE_LIST_ITEMS) || '[]');
                return {
                    listId: listId,
                    listName: localStorage.getItem(LS_ACTIVE_LIST_NAME) || 'Untitled List',
                    items: items,
                    updatedAt: localStorage.getItem(LS_ACTIVE_LIST_UPDATED_AT),
                    source: localStorage.getItem(LS_ACTIVE_LIST_SOURCE) || 'unknown'
                };
            } catch (error) {
                console.error('[Active List] Failed to load:', error);
                return null;
            }
        }
        
        function clearActiveList() {
            localStorage.removeItem(LS_ACTIVE_LIST_ID);
            localStorage.removeItem(LS_ACTIVE_LIST_NAME);
            localStorage.removeItem(LS_ACTIVE_LIST_ITEMS);
            localStorage.removeItem(LS_ACTIVE_LIST_UPDATED_AT);
            localStorage.removeItem(LS_ACTIVE_LIST_SOURCE);
            console.log('[Active List] Cleared');
        }
        
        function hasActiveList() {
            return !!localStorage.getItem(LS_ACTIVE_LIST_ID);
        }
        
        function displayActiveListInfo(activeList) {
            const statusDiv = document.getElementById('activeListStatus');
            const nameDisplay = document.getElementById('activeListNameDisplay');
            const updatedDisplay = document.getElementById('activeListUpdatedDisplay');
            
            nameDisplay.textContent = `${activeList.listName} (${activeList.items.length} items)`;
            
            if (activeList.updatedAt) {
                const date = new Date(activeList.updatedAt);
                updatedDisplay.textContent = `Last updated: ${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
            }
            
            statusDiv.classList.remove('hidden');
            console.log('[Option A] Active list info displayed');
        }
        
        function loadVoiceMappingWithActiveList(activeList) {
            console.log('[Option A] Loading voice mapping with', activeList.items.length, 'items');
            console.log('[Option A] Items:', activeList.items.map(item => item.name || item).join(', '));
            
            // Set inventory items from active list
            inventoryItems = activeList.items.map(item => item.name || item);
            
            // Initialize empty aliases for all items
            inventoryItems.forEach(item => {
                if (!aliasData[item]) {
                    aliasData[item] = [];
                }
            });
            
            // Initialize voice mapping interface
            initializeVoiceMapping();
            
            // Show a banner indicating the list is ready
            showMicroBanner(`‚úì Loaded ${activeList.items.length} items from ${activeList.listName}. Ready for voice mapping!`, 'success');
            console.log('[Option A] Voice mapping interface initialized');
        }
        
        function clearActiveListAndReparse() {
            if (!confirm('This will clear the current list and allow you to upload new images. Continue?')) {
                return;
            }
            
            clearActiveList();
            
            // Hide active list status
            document.getElementById('activeListStatus').classList.add('hidden');
            
            // Show image upload UI
            document.getElementById('voiceImageUploadSection').classList.remove('hidden');
            
            showMicroBanner('Active list cleared. You can now upload new images.', 'success');
            console.log('[Option A] Active list cleared - user can now upload images');
        }

        // ============================================
        // TEXT NORMALIZATION HELPERS
        // ============================================

        function decodeHtmlEntities(str) {
            const textarea = document.createElement('textarea');
            textarea.innerHTML = str;
            return textarea.value;
        }

        function fixMojibake(str) {
            return str
                .replace(/√¢‚Ç¨‚Ñ¢/g, "'")
                .replace(/√¢‚Ç¨≈ì/g, '"')
                .replace(/√¢‚Ç¨\u009D/g, '"')
                .replace(/√¢‚Ç¨ÔøΩ/g, '"')
                .replace(/√¢‚Ç¨"/g, '‚Äì')
                .replace(/√¢‚Ç¨"/g, '‚Äî')
                .replace(/√Ç/g, '');
        }

        function normalizeDisplayText(str) {
            return fixMojibake(decodeHtmlEntities(String(str ?? ''))).trim();
        }

        // MICRO-BANNER FUNCTIONS
        // ============================================

        function showMicroBanner(message, type = 'success') {
            const banner = document.getElementById('microBanner');
            const content = document.getElementById('microBannerContent');
            const icon = document.getElementById('microBannerIcon');
            
            // Use innerHTML to properly render HTML entities
            content.innerHTML = message;
            banner.classList.remove('hidden');
            
            if (type === 'success') {
                icon.className = 'w-10 h-10 rounded-lg flex items-center justify-center bg-green-500/20';
                icon.innerHTML = '<svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
            } else {
                icon.className = 'w-10 h-10 rounded-lg flex items-center justify-center bg-indigo-500/20';
                icon.innerHTML = '<svg class="w-6 h-6 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
            }
            
            // Auto-hide after 8 seconds
            setTimeout(() => {
                hideMicroBanner();
            }, 8000);
        }

        function hideMicroBanner() {
            const banner = document.getElementById('microBanner');
            banner.classList.add('hidden');
        }

        function updateLastRunDisplay() {
            const lastRun = localStorage.getItem(LS_LAST_INVENTORY_RUN_KEY);
            const lastRunText = document.getElementById('lastRunText');
            
            if (lastRun && lastRunText) {
                const date = new Date(lastRun);
                lastRunText.textContent = `Last used: ${date.toLocaleString()}`;
            } else if (lastRunText) {
                lastRunText.textContent = '';
            }
        }

        // Global state
        let currentMode = null;
        let selectedFiles = [];
        let parsedData = null;
        let inventoryItems = [];
        let currentItemIndex = -1;
        let aliasData = {};
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let inventorySourceWasParsed = false;
        
        // Audio-reactive mic overlay variables
        let micAudioCtx = null;
        let micAnalyser = null;
        let micSource = null;
        let micRafId = null;
        let currentStream = null;
        
        // Master list management state
        let masterListLocked = false;
        let currentProjectName = null;
        let listSaved = false;
        let lastRecordedPhrase = null;

        // ============================================
        // MASTER ALIAS PERSISTENCE (localStorage)
        // ============================================

        function parseMasterAliasCsv(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            
            if (lines.length < 2) {
                throw new Error('Alias file is empty or has no data rows');
            }
            
            const dataLines = lines.slice(1);
            const parsed = {};
            
            for (const line of dataLines) {
                const csvMatch = line.match(/^"([^"]*)","(.*)"/);
                
                if (csvMatch) {
                    const itemName = csvMatch[1].trim();
                    const aliasesString = csvMatch[2].trim();
                    
                    if (itemName) {
                        const aliases = aliasesString
                            .split(',')
                            .map(a => a.trim())
                            .filter(a => a);
                        
                        parsed[itemName] = [...new Set(aliases)];
                    }
                }
            }
            
            if (Object.keys(parsed).length === 0) {
                throw new Error('No valid alias data found in file');
            }
            
            return parsed;
        }

        function saveMasterAliasToLocalStorage(csvText, filename) {
            try {
                localStorage.setItem(LS_ALIAS_CSV_KEY, csvText);
                localStorage.setItem(LS_ALIAS_FILENAME_KEY, filename);
                localStorage.setItem(LS_ALIAS_LOADED_AT_KEY, new Date().toISOString());
            } catch (e) {
                console.error('Failed to save aliases to localStorage:', e);
            }
        }

        function clearMasterAliasFromLocalStorage() {
            localStorage.removeItem(LS_ALIAS_CSV_KEY);
            localStorage.removeItem(LS_ALIAS_FILENAME_KEY);
            localStorage.removeItem(LS_ALIAS_LOADED_AT_KEY);
        }

        function tryRestoreMasterAliasesFromLocalStorage() {
            const csvText = localStorage.getItem(LS_ALIAS_CSV_KEY);
            if (!csvText) return false;
            
            try {
                const parsed = parseMasterAliasCsv(csvText);
                
                Object.keys(parsed).forEach(itemName => {
                    aliasData[itemName] = parsed[itemName];
                });
                
                if (inventoryItems.length === 0) {
                    inventoryItems = Object.keys(aliasData);
                }
                
                return true;
            } catch (e) {
                console.error('Failed to restore aliases from localStorage:', e);
                clearMasterAliasFromLocalStorage();
                return false;
            }
        }

        function getMasterAliasStatus() {
            const filename = localStorage.getItem(LS_ALIAS_FILENAME_KEY);
            const loadedAt = localStorage.getItem(LS_ALIAS_LOADED_AT_KEY);
            
            if (!filename) return null;
            
            return {
                filename,
                loadedAt: loadedAt ? new Date(loadedAt) : null
            };
        }

        function updateMasterAliasStatusDisplay() {
            const statusDiv = document.getElementById('masterAliasStatus');
            const filenameDisplay = document.getElementById('aliasFilenameDisplay');
            const status = getMasterAliasStatus();
            
            if (status) {
                const timeAgo = status.loadedAt ? 
                    `(loaded ${new Date(status.loadedAt).toLocaleDateString()})` : '';
                filenameDisplay.textContent = `${status.filename} ${timeAgo}`;
                statusDiv.classList.remove('hidden');
            } else {
                statusDiv.classList.add('hidden');
            }
        }

        function replaceAliasFile() {
            const aliasFileInput = document.getElementById('aliasFileInput');
            if (aliasFileInput) {
                aliasFileInput.click();
            }
        }

        function clearAliasFile() {
            if (!confirm('Clear master aliases? This will remove all saved alias data. You can re-upload an alias file anytime.')) {
                return;
            }
            
            clearMasterAliasFromLocalStorage();
            aliasData = {};
            updateMasterAliasStatusDisplay();
            alert('Master aliases cleared. Upload a new alias file to continue.');
        }

        // Mode selection
        function selectMode(mode) {
            // Dismiss all possible blocking UI
            hideMicroBanner();
            const micOverlay = document.getElementById('microphoneOverlay');
            if (micOverlay) {
                micOverlay.classList.add('hidden');
                micOverlay.style.pointerEvents = 'none';
            }
            
            currentMode = mode;
            document.getElementById('modeSelectionScreen').classList.add('hidden');
            
            if (mode === 'new-setup') {
                document.getElementById('newSetupScreen').classList.remove('hidden');
            } else if (mode === 'voice-mapping') {
                document.getElementById('voiceMappingScreen').classList.remove('hidden');
                
                // OPTION A: Check for Active List first
                const activeList = getActiveList();
                if (activeList) {
                    console.log(`[Option A] Active list found: ${activeList.listName} (${activeList.items.length} items)`);
                    console.log(`[Option A] parse_suppressed_due_to_active_list = true`);
                    
                    // Hide image upload UI (parsing not needed)
                    document.getElementById('voiceImageUploadSection').classList.add('hidden');
                    
                    // Show active list info
                    displayActiveListInfo(activeList);
                    
                    // Load items into voice mapping interface
                    loadVoiceMappingWithActiveList(activeList);
                } else {
                    console.log(`[Option A] No active list found - showing upload UI`);
                    // Show image upload UI (no active list exists)
                    document.getElementById('voiceImageUploadSection').classList.remove('hidden');
                    // Hide active list status
                    document.getElementById('activeListStatus').classList.add('hidden');
                }
                
                const restored = tryRestoreMasterAliasesFromLocalStorage();
                updateMasterAliasStatusDisplay();
                
            } else if (mode === 'daily-count') {
                // Reset Daily Count state for clean session
                inventoryCounts = {};
                commandHistory = [];
                unmappedCommands = [];
                dailyInventory = [];
                dailyAliases = {};
                
                document.getElementById('dailyCountScreen').classList.remove('hidden');
            }
        }

        function showModeSelection() {
            document.getElementById('modeSelectionScreen').classList.remove('hidden');
            document.getElementById('newSetupScreen').classList.add('hidden');
            document.getElementById('voiceMappingScreen').classList.add('hidden');
            document.getElementById('dailyCountScreen').classList.add('hidden');
            currentMode = null;
            
            updateLastRunDisplay();
        }

        // ============================================
        // NEW SETUP MODE
        // ============================================

        const fileInputCamera = document.getElementById('fileInputCamera');
        const fileInputGallery = document.getElementById('fileInputGallery');
        const fileList = document.getElementById('fileList');
        const parseButton = document.getElementById('parseButton');
        const loadingSection = document.getElementById('loadingSection');
        const resultsSection = document.getElementById('resultsSection');
        const errorDiv = document.getElementById('error');

        fileInputCamera.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        fileInputGallery.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            const newFiles = Array.from(files).filter(file => {
                return file.type === 'image/jpeg' || 
                       file.type === 'image/png' || 
                       file.type === 'image/webp';
            });

            if (newFiles.length === 0) {
                showError('Please select valid image files (JPEG, PNG, or WEBP)');
                return;
            }

            // Append to existing files, don't replace
            selectedFiles = [...selectedFiles, ...newFiles];

            if (selectedFiles.length > 30) {
                showError('Maximum 30 images allowed. Only first 30 will be used.');
                selectedFiles = selectedFiles.slice(0, 30);
            }

            displayFileList();
            parseButton.disabled = false;
            hideError();
        }

        function displayFileList() {
            if (selectedFiles.length === 0) {
                fileList.classList.add('hidden');
                return;
            }

            fileList.classList.remove('hidden');
            fileList.innerHTML = selectedFiles.map((file, index) => `
                <div class="flex items-center justify-between p-4 bg-zinc-800 rounded-xl">
                    <span class="text-zinc-300 flex items-center gap-3">
                        <svg class="w-5 h-5 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                        ${file.name} <span class="text-zinc-500">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                    </span>
                    <button onclick="removeFile(${index})" class="px-3 py-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg text-sm font-medium transition-colors">
                        Remove
                    </button>
                </div>
            `).join('');
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            displayFileList();
            
            if (selectedFiles.length === 0) {
                parseButton.disabled = true;
            }
        }

        parseButton.addEventListener('click', async () => {
            if (selectedFiles.length === 0) return;

            hideError();
            loadingSection.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            parseButton.disabled = true;
            
            // Show loading state on button
            const buttonText = document.getElementById('parseButtonText');
            buttonText.innerHTML = '<div class="spinner"></div> Processing...';

            const formData = new FormData();
            selectedFiles.forEach(file => {
                formData.append('images', file);
            });

            try {
                const response = await fetch('/vision/parse', {
                    method: 'POST',
                    body: formData
                });

                // Resilient JSON parsing - check content type first
                const contentType = response.headers.get('content-type');
                const responseText = await response.text();
                
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error(`Expected JSON but got ${contentType || 'unknown'} (status ${response.status}): ${responseText.substring(0, 200)}...`);
                }
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    throw new Error(`Failed to parse JSON response: ${parseError.message}. Response: ${responseText.substring(0, 200)}...`);
                }

                if (!response.ok) {
                    throw new Error(data.details || data.error || 'Parsing failed');
                }

                parsedData = data;
                displayResults(data);
                
                // OPTION A: Save as Active List (Single Source of Truth)
                const items = data.items || data.extracted || [];
                const listName = `Scan ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`;
                saveActiveList(data.scanId, listName, items, 'new_project_parse');
                console.log(`[Option A] Active list saved: ${items.length} items`);
                
                // Update last run timestamp
                localStorage.setItem(LS_LAST_INVENTORY_RUN_KEY, new Date().toISOString());
                
                // Show closure banner with time estimate
                const estimateMinutes = Math.max(5, Math.round(selectedFiles.length * 1.5));
                showMicroBanner(`‚úì Inventory ready. Saved ~${estimateMinutes} minutes of manual entry.`, 'success');
                
                // Auto-navigation removed - user must manually navigate after editing/saving
                
            } catch (error) {
                console.error('Error:', error);
                showError(`Error: ${error.message}`);
            } finally {
                loadingSection.classList.add('hidden');
                parseButton.disabled = false;
                buttonText.innerHTML = `
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    Parse Inventory
                `;
            }
        });

        // Global state for selected item
        window.selectedItemId = null;
        window.scanItems = [];
        
        function renderItemCards() {
            const container = document.getElementById('itemsScrollContainer');
            if (!window.scanItems || window.scanItems.length === 0) {
                container.innerHTML = '<p class="text-zinc-400 text-center py-8">No items found</p>';
                return;
            }
            
            container.innerHTML = window.scanItems.map(item => {
                const isSelected = window.selectedItemId === item.id;
                const countColor = item.count > 0 ? 'text-orange-400' : 'text-zinc-600';
                const borderClass = isSelected ? 'border-2 border-orange-400' : 'border-2 border-transparent';
                const editButton = !masterListLocked ? `<button onclick="event.stopPropagation(); editItemName('${item.id}')" class="px-2 py-1 bg-orange-500/20 hover:bg-orange-500/30 text-orange-400 rounded text-xs font-medium transition-colors ml-2">Edit</button>` : '';
                
                return `
                    <div 
                        class="item-card ${borderClass} bg-zinc-800/40 rounded-2xl p-5 flex items-center justify-between hover:bg-zinc-800/60 transition-all shadow-lg"
                        data-item-id="${item.id}"
                    >
                        <div class="item-name text-white text-lg font-bold flex-1">
                            ${item.name}
                            ${editButton}
                        </div>
                        <div 
                            class="item-count ${countColor} text-2xl font-bold min-w-[60px] text-right"
                            onclick="event.stopPropagation(); editCount('${item.id}')"
                        >
                            ${item.count}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function selectItem(itemId) {
            window.selectedItemId = itemId;
            renderItemCards();
        }
        
        function editCount(itemId) {
            const item = window.scanItems.find(i => i.id === itemId);
            if (!item) return;
            
            const newCount = prompt(`Enter count for ${item.name}:`, item.count);
            if (newCount !== null) {
                const parsed = parseInt(newCount, 10);
                if (!isNaN(parsed) && parsed >= 0) {
                    item.count = parsed;
                    renderItemCards();
                }
            }
        }
        
        function editItemName(itemId) {
            if (masterListLocked) {
                alert('List is locked. Cannot edit item names after saving.');
                return;
            }
            
            const item = window.scanItems.find(i => i.id === itemId);
            if (!item) return;
            
            const newName = prompt(`Edit item name:`, item.name);
            if (newName !== null) {
                // Validate: trim and collapse whitespace
                const trimmed = newName.trim().replace(/\s+/g, ' ');
                if (trimmed === '') {
                    alert('Item name cannot be empty');
                    return;
                }
                item.name = trimmed;
                // Update ID to match new name
                item.id = trimmed.toLowerCase().replace(/[^a-z0-9]/g, '_');
                renderItemCards();
            }
        }

        function displayResults(data) {
            // Store scanId for downloads
            window.currentScanId = data.scanId;
            
            const items = data.items || data.extracted || [];
            document.getElementById('itemCount').textContent = items.length;
            document.getElementById('imageCount').textContent = selectedFiles.length;

            // Store items in global state for editing
            window.scanItems = items.map(item => ({
                id: item.id || item.name.toLowerCase().replace(/[^a-z0-9]/g, '_'),
                name: item.name || item.raw_text || 'Unknown',
                count: item.count || 0
            }));
            
            renderItemCards();
            resultsSection.classList.remove('hidden');
        }

        // Download CSV button
        document.getElementById('downloadButton').addEventListener('click', async () => {
            if (!window.currentScanId) {
                alert('No scan results available');
                return;
            }
            
            // Update counts on backend first
            try {
                await fetch('/vision/update-counts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        scanId: window.currentScanId,
                        items: window.scanItems
                    })
                });
            } catch (error) {
                console.error('Failed to update counts:', error);
            }
            
            // Download via backend endpoint
            const url = `/vision/download.csv?scanId=${window.currentScanId}`;
            const a = document.createElement('a');
            a.href = url;
            a.download = `scan_${window.currentScanId}.csv`;
            a.click();
        });
        
        // Download JSON button (add new button if doesn't exist)
        const downloadJsonBtn = document.getElementById('downloadJsonButton');
        if (downloadJsonBtn) {
            downloadJsonBtn.addEventListener('click', () => {
                if (!window.currentScanId) {
                    alert('No scan results available');
                    return;
                }
                
                // Download via backend endpoint
                const url = `/vision/download.json?scanId=${window.currentScanId}`;
                const a = document.createElement('a');
                a.href = url;
                a.download = `scan_${window.currentScanId}.json`;
                a.click();
            });
        }
        
        // Save List to Server button
        document.getElementById('saveListButton').addEventListener('click', async () => {
            const projectNameInput = document.getElementById('projectNameInput');
            const projectName = projectNameInput.value.trim();
            const saveStatus = document.getElementById('saveStatus');
            const continueBtn = document.getElementById('continueToVoiceMappingButton');
            
            if (!projectName) {
                saveStatus.textContent = 'Please enter a project name';
                saveStatus.className = 'mt-3 p-3 rounded-lg text-sm bg-red-500/20 text-red-400';
                saveStatus.classList.remove('hidden');
                return;
            }
            
            if (!window.scanItems || window.scanItems.length === 0) {
                saveStatus.textContent = 'No items to save';
                saveStatus.className = 'mt-3 p-3 rounded-lg text-sm bg-red-500/20 text-red-400';
                saveStatus.classList.remove('hidden');
                return;
            }
            
            try {
                const items = window.scanItems.map(item => item.name);
                const response = await fetch('/projects/save-master-list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ projectName, items })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to save list');
                }
                
                // Lock the list
                masterListLocked = true;
                currentProjectName = projectName;
                listSaved = true;
                
                // Update UI
                saveStatus.textContent = `‚úì List saved successfully as "${projectName}"`;
                saveStatus.className = 'mt-3 p-3 rounded-lg text-sm bg-green-500/20 text-green-400';
                saveStatus.classList.remove('hidden');
                
                // Disable save button and project name input
                document.getElementById('saveListButton').disabled = true;
                projectNameInput.disabled = true;
                
                // Enable continue button
                continueBtn.disabled = false;
                
                // Save to active list for voice mapping
                const scanId = window.currentScanId || `project_${Date.now()}`;
                saveActiveList(scanId, projectName, window.scanItems.map(item => item.name), 'new_project_save');
                
                // Re-render to hide edit buttons
                renderItemCards();
                
            } catch (error) {
                console.error('Save error:', error);
                saveStatus.textContent = `Error: ${error.message}`;
                saveStatus.className = 'mt-3 p-3 rounded-lg text-sm bg-red-500/20 text-red-400';
                saveStatus.classList.remove('hidden');
            }
        });
        
        // Continue to Voice Mapping button
        document.getElementById('continueToVoiceMappingButton').addEventListener('click', () => {
            if (!listSaved) {
                alert('Please save the list first');
                return;
            }
            selectMode('voice-mapping');
        });

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            errorDiv.classList.add('hidden');
        }

        // ============================================
        // VOICE MAPPING MODE
        // ============================================

        let voiceSelectedFiles = [];

        const voiceFileInputCamera = document.getElementById('voiceFileInputCamera');
        const voiceFileInputGallery = document.getElementById('voiceFileInputGallery');
        const voiceFileList = document.getElementById('voiceFileList');
        const voiceParseButton = document.getElementById('voiceParseButton');
        const voiceLoadingSection = document.getElementById('voiceLoadingSection');
        const inventoryFileZone = document.getElementById('inventoryFileZone');
        const inventoryFileInput = document.getElementById('inventoryFileInput');
        const voiceSetupError = document.getElementById('voiceSetupError');

        voiceFileInputCamera.addEventListener('change', (e) => {
            handleVoiceFiles(e.target.files);
        });

        voiceFileInputGallery.addEventListener('change', (e) => {
            handleVoiceFiles(e.target.files);
        });

        function handleVoiceFiles(files) {
            const newFiles = Array.from(files).filter(file => {
                return file.type === 'image/jpeg' || 
                       file.type === 'image/png' || 
                       file.type === 'image/webp';
            });

            if (newFiles.length === 0) {
                showVoiceSetupError('Please select valid image files (JPEG, PNG, or WEBP)');
                return;
            }

            // Append to existing files, don't replace
            voiceSelectedFiles = [...voiceSelectedFiles, ...newFiles];

            if (voiceSelectedFiles.length > 30) {
                showVoiceSetupError('Maximum 30 images allowed. Only first 30 will be used.');
                voiceSelectedFiles = voiceSelectedFiles.slice(0, 30);
            }

            displayVoiceFileList();
            voiceParseButton.disabled = false;
            hideVoiceSetupError();
        }

        function displayVoiceFileList() {
            if (voiceSelectedFiles.length === 0) {
                voiceFileList.classList.add('hidden');
                return;
            }

            voiceFileList.classList.remove('hidden');
            voiceFileList.innerHTML = voiceSelectedFiles.map((file, index) => `
                <div class="flex items-center justify-between p-4 bg-zinc-800 rounded-xl">
                    <span class="text-zinc-300 flex items-center gap-3">
                        <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                        ${file.name} <span class="text-zinc-500">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                    </span>
                    <button onclick="removeVoiceFile(${index})" class="px-3 py-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg text-sm font-medium transition-colors">
                        Remove
                    </button>
                </div>
            `).join('');
        }

        function removeVoiceFile(index) {
            voiceSelectedFiles.splice(index, 1);
            displayVoiceFileList();
            
            if (voiceSelectedFiles.length === 0) {
                voiceParseButton.disabled = true;
            }
        }

        voiceParseButton.addEventListener('click', async () => {
            if (voiceSelectedFiles.length === 0) return;

            hideVoiceSetupError();
            voiceLoadingSection.classList.remove('hidden');
            document.getElementById('voiceSetupChoice').classList.add('hidden');
            voiceParseButton.disabled = true;

            const formData = new FormData();
            voiceSelectedFiles.forEach(file => {
                formData.append('images', file);
            });

            try {
                const response = await fetch('/vision/parse', {
                    method: 'POST',
                    body: formData
                });

                // Resilient JSON parsing - check content type first
                const contentType = response.headers.get('content-type');
                const responseText = await response.text();
                
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error(`Expected JSON but got ${contentType || 'unknown'} (status ${response.status}): ${responseText.substring(0, 200)}...`);
                }
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    throw new Error(`Failed to parse JSON response: ${parseError.message}. Response: ${responseText.substring(0, 200)}...`);
                }

                if (!response.ok) {
                    throw new Error(data.details || data.error || 'Parsing failed');
                }

                inventoryItems = (data.extracted || []).map(item => item.raw_text);
                
                if (inventoryItems.length === 0) {
                    throw new Error('No items found in images');
                }

                inventorySourceWasParsed = true;
                initializeVoiceMapping();
                
            } catch (error) {
                console.error('Error:', error);
                showVoiceSetupError(`Error: ${error.message}`);
                document.getElementById('voiceSetupChoice').classList.remove('hidden');
            } finally {
                voiceLoadingSection.classList.add('hidden');
                voiceParseButton.disabled = false;
            }
        });

        // Server-side list loader
        document.getElementById('loadFromServerButton').addEventListener('click', async () => {
            const projectNameInput = document.getElementById('serverProjectNameInput');
            const projectName = projectNameInput.value.trim();
            const statusDiv = document.getElementById('serverLoadStatus');
            
            if (!projectName) {
                statusDiv.textContent = 'Please enter a project name';
                statusDiv.className = 'mt-3 p-3 rounded-lg text-sm bg-red-500/20 text-red-400';
                statusDiv.classList.remove('hidden');
                return;
            }
            
            try {
                statusDiv.textContent = 'Loading...';
                statusDiv.className = 'mt-3 p-3 rounded-lg text-sm bg-blue-500/20 text-blue-400';
                statusDiv.classList.remove('hidden');
                
                const response = await fetch(`/projects/${encodeURIComponent(projectName)}/master-list`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load list from server');
                }
                
                if (!data.items || data.items.length === 0) {
                    throw new Error('No items found in project');
                }
                
                // Load items into voice mapping
                inventoryItems = data.items;
                inventorySourceWasParsed = false;
                
                // Hide setup and show voice mapping interface
                document.getElementById('voiceSetupChoice').classList.add('hidden');
                initializeVoiceMapping();
                
                showMicroBanner(`‚úì Loaded ${data.items.length} items from "${projectName}"`, 'success');
                
            } catch (error) {
                console.error('Server load error:', error);
                statusDiv.textContent = `Error: ${error.message}`;
                statusDiv.className = 'mt-3 p-3 rounded-lg text-sm bg-red-500/20 text-red-400';
                statusDiv.classList.remove('hidden');
            }
        });
        
        inventoryFileZone.addEventListener('click', () => inventoryFileInput.click());

        inventoryFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            hideVoiceSetupError();
            voiceLoadingSection.classList.remove('hidden');
            document.getElementById('voiceSetupChoice').classList.add('hidden');

            try {
                const text = await file.text();
                
                let items = [];
                if (file.name.endsWith('.csv')) {
                    const lines = text.split('\n').filter(line => line.trim());
                    items = lines.slice(1).map(line => {
                        const match = line.match(/^"([^"]*)"/);
                        if (match) return match[1];
                        return line.split(',')[0].trim();
                    }).filter(item => item);
                } else {
                    items = text.split('\n')
                        .map(line => line.trim())
                        .filter(line => line);
                }

                if (items.length === 0) {
                    throw new Error('No items found in file');
                }

                inventoryItems = items;
                inventorySourceWasParsed = false;
                initializeVoiceMapping();

            } catch (error) {
                console.error('Error loading file:', error);
                showVoiceSetupError(`Error loading file: ${error.message}`);
                document.getElementById('voiceSetupChoice').classList.remove('hidden');
            } finally {
                voiceLoadingSection.classList.add('hidden');
            }
        });

        inventoryFileZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            inventoryFileZone.classList.add('pulse-border', 'bg-emerald-500/5');
        });

        inventoryFileZone.addEventListener('dragleave', () => {
            inventoryFileZone.classList.remove('pulse-border', 'bg-emerald-500/5');
        });

        inventoryFileZone.addEventListener('drop', (e) => {
            e.preventDefault();
            inventoryFileZone.classList.remove('pulse-border', 'bg-emerald-500/5');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                inventoryFileInput.files = files;
                inventoryFileInput.dispatchEvent(new Event('change'));
            }
        });

        const aliasFileZone = document.getElementById('aliasFileZone');
        const aliasFileInput = document.getElementById('aliasFileInput');

        aliasFileZone.addEventListener('click', () => aliasFileInput.click());

        aliasFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            hideVoiceSetupError();
            voiceLoadingSection.classList.remove('hidden');
            document.getElementById('voiceSetupChoice').classList.add('hidden');

            try {
                const text = await file.text();
                
                const lines = text.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    throw new Error('Alias file is empty or has no data rows');
                }
                
                const dataLines = lines.slice(1);
                
                const loadedAliasData = {};
                
                for (const line of dataLines) {
                    const csvMatch = line.match(/^"([^"]*)","(.*)"/);
                    
                    if (csvMatch) {
                        const itemName = csvMatch[1].trim();
                        const aliasesString = csvMatch[2].trim();
                        
                        if (itemName) {
                            const aliases = aliasesString
                                .split(',')
                                .map(a => a.trim())
                                .filter(a => a);
                            
                            loadedAliasData[itemName] = [...new Set(aliases)];
                        }
                    }
                }
                
                if (Object.keys(loadedAliasData).length === 0) {
                    throw new Error('No valid alias data found in file');
                }
                
                saveMasterAliasToLocalStorage(text, file.name);
                
                aliasData = loadedAliasData;
                
                inventoryItems = Object.keys(aliasData);
                
                inventorySourceWasParsed = false;
                
                updateMasterAliasStatusDisplay();
                
                initializeVoiceMapping();

            } catch (error) {
                console.error('Error loading alias file:', error);
                showVoiceSetupError(`Error loading alias file: ${error.message}`);
                document.getElementById('voiceSetupChoice').classList.remove('hidden');
            } finally {
                voiceLoadingSection.classList.add('hidden');
            }
        });

        aliasFileZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            aliasFileZone.classList.add('pulse-border', 'bg-indigo-500/5');
        });

        aliasFileZone.addEventListener('dragleave', () => {
            aliasFileZone.classList.remove('pulse-border', 'bg-indigo-500/5');
        });

        

        // REMOVED: Voice Mapping KrushProfile Upload Handler (now always-on server-side)


        aliasFileZone.addEventListener('drop', (e) => {
            e.preventDefault();
            aliasFileZone.classList.remove('pulse-border', 'bg-indigo-500/5');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                aliasFileInput.files = files;
                aliasFileInput.dispatchEvent(new Event('change'));
            }
        });

        function showVoiceSetupError(message) {
            voiceSetupError.textContent = message;
            voiceSetupError.classList.remove('hidden');
        }

        function hideVoiceSetupError() {
            voiceSetupError.classList.add('hidden');
        }

        function initializeVoiceMapping() {
            document.getElementById('voiceSetupChoice').classList.add('hidden');
            document.getElementById('voiceMappingInterface').classList.remove('hidden');

            inventoryItems.forEach(item => {
                if (!aliasData[item]) {
                    aliasData[item] = [];
                }
            });

            renderInventoryList();
            updateProgress();
        }

        function renderInventoryList() {
            const listDiv = document.getElementById('inventoryList');
            listDiv.innerHTML = inventoryItems.map((item, index) => {
                const aliases = aliasData[item] || [];
                const isActive = index === currentItemIndex;
                const isCompleted = aliases.length > 0;
                
                let className = 'p-4 border-b border-zinc-800 cursor-pointer transition-all';
                if (isActive) {
                    className += ' bg-gradient-to-r from-indigo-600 to-purple-600 text-white';
                } else if (isCompleted) {
                    className += ' hover:bg-zinc-800/50'; // Glass effect
                } else {
                    className += ' hover:bg-zinc-800/50';
                }

                let badgeHtml = '';
                if (aliases.length === 0) {
                    badgeHtml = '<span class="inline-block px-2 py-1 text-xs font-semibold rounded-lg bg-yellow-500/20 text-yellow-400 ml-3">Needs alias</span>';
                }

                return `
                    <div class="${className}" onclick="selectInventoryItem(${index})">
                        <div class="font-semibold flex items-center">
                            ${item}${badgeHtml}
                        </div>
                        ${(isActive || aliases.length > 0) ? `
                            <div class="text-sm mt-2 ${isActive ? 'text-indigo-100' : 'text-zinc-400'}">
                                üé§ ${aliases.length > 0 ? `${aliases.length} alias${aliases.length > 1 ? 'es' : ''}: ${aliases.join(', ')}` : 'No aliases yet'}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function selectInventoryItem(index) {
            currentItemIndex = index;
            lastRecordedPhrase = null; // Reset when changing items
            renderInventoryList();
            updateVoiceStatus();
            updateCurrentPhrases();
            document.getElementById('recordButton').disabled = false;
        }

        function updateVoiceStatus() {
            const statusDiv = document.getElementById('voiceStatus');
            if (currentItemIndex === -1) {
                statusDiv.innerHTML = `
                    <h4 class="text-xl font-semibold mb-2">Select an item to begin</h4>
                    <p class="text-zinc-400">Click any item below, then press "Record Voice Alias"</p>
                `;
                statusDiv.className = 'bg-zinc-800/50 rounded-xl p-6 mb-6 text-center';
            } else {
                const item = inventoryItems[currentItemIndex];
                const lastRecordedDisplay = lastRecordedPhrase 
                    ? `<div class="mt-3 p-3 bg-orange-500/10 border border-orange-500/30 rounded-lg">
                        <p class="text-xs text-orange-300 font-semibold mb-1">Last recorded:</p>
                        <p class="text-orange-400 font-medium">"${lastRecordedPhrase}"</p>
                       </div>` 
                    : '';
                statusDiv.innerHTML = `
                    <h4 class="text-xl font-semibold mb-2">Current item: ${item}</h4>
                    <p class="text-zinc-400">${isRecording ? 'üéôÔ∏è Recording... Speak now!' : 'Press "Record Voice Alias" to start'}</p>
                    ${lastRecordedDisplay}
                `;
                statusDiv.className = isRecording ? 
                    'bg-red-500/20 border border-red-500/50 rounded-xl p-6 mb-6 text-center' : 
                    'bg-zinc-800/50 rounded-xl p-6 mb-6 text-center';
            }
        }

        function updateCurrentPhrases() {
            const phrasesDiv = document.getElementById('currentPhrases');
            const phraseList = document.getElementById('phraseList');
            
            if (currentItemIndex === -1) {
                phrasesDiv.classList.add('hidden');
                return;
            }

            const item = inventoryItems[currentItemIndex];
            const aliases = aliasData[item] || [];

            phrasesDiv.classList.remove('hidden');
            
            if (aliases.length === 0) {
                phraseList.innerHTML = '<div class="text-zinc-400 italic text-center p-4">No aliases recorded yet</div>';
            } else {
                phraseList.innerHTML = aliases.map((phrase, index) => `
                    <div class="flex items-center justify-between p-3 bg-zinc-800 rounded-lg">
                        <span class="text-zinc-200">üé§ "${phrase}"</span>
                        <button onclick="deleteAlias(${index})" class="px-3 py-1 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg text-sm font-medium transition-colors">
                            Delete
                        </button>
                    </div>
                `).join('');
            }
        }

        function deleteAlias(phraseIndex) {
            if (currentItemIndex === -1) return;
            
            const item = inventoryItems[currentItemIndex];
            if (!aliasData[item] || phraseIndex < 0 || phraseIndex >= aliasData[item].length) {
                return;
            }
            
            aliasData[item].splice(phraseIndex, 1);
            
            updateCurrentPhrases();
            renderInventoryList();
            updateProgress();
        }

        function updateProgress() {
            const completed = Object.values(aliasData).filter(arr => arr.length > 0).length;
            const total = inventoryItems.length;
            const percentage = total > 0 ? (completed / total) * 100 : 0;
            document.getElementById('mappingProgress').style.width = `${percentage}%`;
            
            const progressText = document.getElementById('mappingProgressText');
            if (progressText) {
                progressText.textContent = `${completed} of ${total} items mapped`;
            }
        }

        
        function updateSkipButtonState() {
            const btn = document.getElementById('skipButton');
            if (!btn) return;
            if (isRecording) {
                btn.disabled = true;
                btn.classList.remove('gradient-success');
                btn.classList.add('bg-zinc-700');
            } else {
                btn.disabled = false;
                btn.classList.remove('bg-zinc-700');
                btn.classList.add('gradient-success');
            }
        }

        function skipCurrentItem() {
            if (isRecording) {
                console.log('Auto-stopping recording before skip');
                stopRecording();
                setTimeout(() => {
                    moveToNextItem();
                }, 500);
            } else {
                moveToNextItem();
            }
        }

        function moveToNextItem() {
            if (currentItemIndex < inventoryItems.length - 1) {
                selectInventoryItem(currentItemIndex + 1);
            } else {
                currentItemIndex = -1;
                renderInventoryList();
                updateVoiceStatus();
                document.getElementById('recordButton').disabled = true;
            }
        }

        document.getElementById('recordButton').addEventListener('click', toggleRecording);
        
        // Microphone overlay control - tap mic core to stop recording
        document.getElementById('micCore').addEventListener('click', () => {
            console.log('[Microphone Overlay] Tapped - stopping recording');
            stopRecording();
        });

        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                currentStream = stream; // Store globally for audio-reactive
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await processVoiceRecording(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                };

                mediaRecorder.start();
                isRecording = true;
                
                // Show full-screen microphone overlay
                const overlay = document.getElementById('microphoneOverlay');
                overlay.classList.remove('hidden');
                overlay.setAttribute('aria-hidden', 'false');
                console.log('[Microphone Overlay] Displayed - recording started');
                
                // Start audio-reactive pulse
                startMicReactive(stream);
                
                document.getElementById('recordButtonText').textContent = 'Stop Recording';
                updateSkipButtonState();
                updateVoiceStatus();

            } catch (error) {
                console.error('Error accessing microphone:', error);
                showVoiceError('Could not access microphone. Please check permissions.');
                // Do NOT show overlay if recording fails
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                isRecording = false;
                
                // Stop audio-reactive
                stopMicReactive();
                
                // Hide full-screen microphone overlay
                const overlay = document.getElementById('microphoneOverlay');
                overlay.classList.add('hidden');
                overlay.setAttribute('aria-hidden', 'true');
                // Reset scale in case audio-reactive was used
                const core = document.getElementById('micCore');
                if (core) core.style.setProperty('--pulseScale', '1');
                console.log('[Microphone Overlay] Hidden - recording stopped');
                
                document.getElementById('recordButtonText').textContent = 'Record Voice Alias';
                updateSkipButtonState();
                updateVoiceStatus();
            }
        }

        async function processVoiceRecording(audioBlob) {
            if (currentItemIndex === -1) return;

            try {
                showVoiceSuccess('Processing audio...');

                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');

                const response = await fetch('/process-voice', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.details || data.error || 'Voice processing failed');
                }

                const transcribedPhrase = data.transcription.trim();

                if (!transcribedPhrase) {
                    showVoiceError('No speech detected. Please try again.');
                    return;
                }

                const item = inventoryItems[currentItemIndex];
                if (!aliasData[item].includes(transcribedPhrase)) {
                    aliasData[item].push(transcribedPhrase);
                }
                
                // Store last recorded phrase and update status display
                lastRecordedPhrase = transcribedPhrase;
                updateVoiceStatus();

                renderInventoryList();
                updateCurrentPhrases();
                updateProgress();
                showVoiceSuccess(`Added: "${transcribedPhrase}"`);

            } catch (error) {
                console.error('Error processing voice:', error);
                showVoiceError(`Failed to process voice: ${error.message}`);
            }
        }

        // ============================================
        // AUDIO-REACTIVE MIC OVERLAY (AGGRESSIVE MODE)
        // ============================================
        
        function startMicReactive(stream) {
            try {
                // Create audio context and analyser
                micAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
                micAnalyser = micAudioCtx.createAnalyser();
                micAnalyser.fftSize = 1024;

                micSource = micAudioCtx.createMediaStreamSource(stream);
                micSource.connect(micAnalyser);

                const data = new Uint8Array(micAnalyser.frequencyBinCount);
                const core = document.getElementById('micCore');

                function tick() {
                    micAnalyser.getByteTimeDomainData(data);

                    // Calculate RMS amplitude (0..~1)
                    let sum = 0;
                    for (let i = 0; i < data.length; i++) {
                        const v = (data[i] - 128) / 128; // Normalize to -1..1
                        sum += v * v;
                    }
                    const rms = Math.sqrt(sum / data.length);

                    // Aggressive mapping: 1.00 ‚Üí 1.20 (tune for more/less punch)
                    const scale = Math.min(1.20, 1.00 + rms * 0.55);
                    core.style.setProperty('--pulseScale', scale.toFixed(3));

                    micRafId = requestAnimationFrame(tick);
                }
                tick();
                
                console.log('[Audio-Reactive] Started');
            } catch (error) {
                console.error('[Audio-Reactive] Failed to start:', error);
                // Fail silently - overlay will still work with fixed animation
            }
        }

        function stopMicReactive() {
            if (micRafId) {
                cancelAnimationFrame(micRafId);
                micRafId = null;
            }
            if (micSource) {
                micSource.disconnect();
                micSource = null;
            }
            micAnalyser = null;
            if (micAudioCtx) {
                micAudioCtx.close();
                micAudioCtx = null;
            }
            console.log('[Audio-Reactive] Stopped');
        }

        document.getElementById('finishMappingButton').addEventListener('click', downloadAliases);

        function downloadAliases() {
            const timestamp = new Date().toISOString().slice(0,10);
            
            const aliasCsvLines = ['Line Item,Aliases\n'];
            
            let itemsWithAliases = 0;
            for (const [item, aliases] of Object.entries(aliasData)) {
                if (aliases.length > 0) {
                    const aliasesString = aliases.join(', ');
                    aliasCsvLines.push(`"${item}","${aliasesString}"\n`);
                    itemsWithAliases++;
                }
            }
            
            const aliasCsvContent = aliasCsvLines.join('');
            
            const currentFilename = localStorage.getItem(LS_ALIAS_FILENAME_KEY) || `inventory_aliases_${timestamp}.csv`;
            saveMasterAliasToLocalStorage(aliasCsvContent, currentFilename);
            
            const aliasBlob = new Blob([aliasCsvContent], { type: 'text/csv' });
            const aliasUrl = window.URL.createObjectURL(aliasBlob);
            
            let inventoryUrl = null;
            if (inventorySourceWasParsed) {
                const inventoryCsv = ['Item Name\n']
                    .concat(inventoryItems.map(item => `"${item}"`))
                    .join('\n');
                
                const inventoryBlob = new Blob([inventoryCsv], { type: 'text/csv' });
                inventoryUrl = window.URL.createObjectURL(inventoryBlob);
            }

            showDownloadDialog(inventoryUrl, aliasUrl, timestamp);
        }

        function showDownloadDialog(inventoryUrl, aliasUrl, timestamp) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(4px);
            `;

            const dialog = document.createElement('div');
            dialog.className = 'bg-zinc-900 border border-zinc-800 rounded-2xl p-8 max-w-md w-full mx-4';
            dialog.innerHTML = `
                <h2 class="text-2xl font-bold mb-4 text-center">üì• Download Files</h2>
                <p class="text-zinc-400 mb-6 text-center">Name and download your ${inventoryUrl ? 'inventory files' : 'alias file'}</p>
                
                ${inventoryUrl ? `
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-zinc-300 mb-2">Inventory List Name:</label>
                        <input type="text" id="inventoryName" value="inventory_list_${timestamp}" 
                            class="w-full px-4 py-3 bg-zinc-800 border border-zinc-700 rounded-xl text-white focus:border-orange-500 focus:outline-none">
                    </div>
                ` : ''}

                <div class="mb-6">
                    <label class="block text-sm font-medium text-zinc-300 mb-2">Aliases File Name:</label>
                    <input type="text" id="aliasName" value="inventory_aliases_${timestamp}" 
                        class="w-full px-4 py-3 bg-zinc-800 border border-zinc-700 rounded-xl text-white focus:border-orange-500 focus:outline-none">
                    ${Object.values(aliasData).every(arr => arr.length === 0) ? 
                        '<p class="text-yellow-400 text-sm mt-2">‚ö†Ô∏è Warning: No aliases recorded - file will be empty</p>' : ''}}
                </div>

                <div class="flex gap-3">
                    <button id="cancelDownload" class="flex-1 py-3 bg-zinc-800 hover:bg-zinc-700 rounded-xl font-semibold transition-colors">
                        Cancel
                    </button>
                    <button id="confirmDownload" class="flex-1 py-3 gradient-primary hover:shadow-2xl hover:shadow-orange-500/50 rounded-xl font-semibold transition-all">
                        üì• Download
                    </button>
                </div>
            `;

            overlay.appendChild(dialog);
            document.body.appendChild(overlay);

            document.getElementById('cancelDownload').addEventListener('click', () => {
                document.body.removeChild(overlay);
                if (inventoryUrl) window.URL.revokeObjectURL(inventoryUrl);
                window.URL.revokeObjectURL(aliasUrl);
            });

            document.getElementById('confirmDownload').addEventListener('click', () => {
                const inventoryName = inventoryUrl ? document.getElementById('inventoryName').value.trim() : null;
                const aliasName = document.getElementById('aliasName').value.trim();

                if (inventoryUrl && inventoryName) {
                    const inventoryLink = document.createElement('a');
                    inventoryLink.href = inventoryUrl;
                    inventoryLink.download = `${inventoryName}.csv`;
                    document.body.appendChild(inventoryLink);
                    inventoryLink.click();
                    document.body.removeChild(inventoryLink);
                    window.URL.revokeObjectURL(inventoryUrl);
                }

                setTimeout(() => {
                    if (!aliasUrl) {
                        showVoiceError('Failed to create alias file');
                        return;
                    }
                    
                    const aliasLink = document.createElement('a');
                    aliasLink.href = aliasUrl;
                    aliasLink.download = `${aliasName}.csv`;
                    document.body.appendChild(aliasLink);
                    aliasLink.click();
                    document.body.removeChild(aliasLink);
                    
                    setTimeout(() => {
                        window.URL.revokeObjectURL(aliasUrl);
                    }, 1000);
                }, inventoryUrl ? 500 : 0);

                document.body.removeChild(overlay);
                
                // Update last run timestamp
                localStorage.setItem(LS_LAST_INVENTORY_RUN_KEY, new Date().toISOString());
                
                const hasAliases = Object.values(aliasData).some(arr => arr.length > 0);
                const message = inventoryUrl ? 
                    (hasAliases ? 'Inventory list and aliases downloaded!' : 'Inventory list downloaded! Alias file is empty.') :
                    (hasAliases ? 'Aliases downloaded successfully!' : 'Empty alias file downloaded.');
                
                showVoiceSuccess(message);
                
                if (hasAliases) {
                    showMicroBanner("‚úì Mapping saved. You're ready for Daily Count.", "success");
                }
            });
        }

        function showVoiceError(message) {
            const errorDiv = document.getElementById('voiceError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        function showVoiceSuccess(message) {
            const successDiv = document.getElementById('voiceSuccess');
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
            setTimeout(() => successDiv.classList.add('hidden'), 3000);
        }


        // ============================================
        // DAILY COUNT MODE
        // ============================================

        let dailyInventory = [];
        let dailyAliases = {};
        
        // ============================================
        // KRUSHPROFILE - PERSONALIZED VOICE LEARNING
        // ============================================
        
        const KRUSH_PROFILE_KEY = 'krush_voice_profile_v1';
        let krushProfile = {}; // Format: { "INVENTORY_ITEM": ["variant1", "variant2", ...] }
        let krushProfileActive = false;
        let krushProfilePendingChanges = {}; // Track pending changes for batch save
        let krushProfileAutoSaveTimer = null;
        let krushProfileLastSyncTime = null;
        
        // ALWAYS-ON SERVER-SIDE PROFILE MANAGEMENT
        // Auto-load KrushProfile from server on app start
        async function loadKrushProfileFromServer() {
            try {
                console.log('[KrushProfile] Auto-loading from server...');
                
                // TODO: Replace with actual server endpoint
                // const response = await fetch('/krush/profile');
                // if (!response.ok) throw new Error('Failed to load profile');
                // const data = await response.json();
                // krushProfile = data.items || {};
                
                // For now, load from localStorage as fallback
                const stored = localStorage.getItem(KRUSH_PROFILE_KEY);
                if (stored) {
                    krushProfile = JSON.parse(stored);
                }
                
                krushProfileActive = Object.keys(krushProfile).length > 0;
                krushProfileLastSyncTime = new Date();
                console.log(`[KrushProfile] Loaded from server: ${Object.keys(krushProfile).length} items`);
                
                if (krushProfileActive) {
                    console.log('[KrushProfile] Active - learning your voice...');
                }
                
                return krushProfile;
            } catch (e) {
                console.error('[KrushProfile] Failed to load from server:', e);
                // Fallback to localStorage
                const stored = localStorage.getItem(KRUSH_PROFILE_KEY);
                if (stored) {
                    krushProfile = JSON.parse(stored);
                    krushProfileActive = Object.keys(krushProfile).length > 0;
                }
                return krushProfile;
            }
        }
        
        // Save KrushProfile to server (batch save pending changes)
        async function saveKrushProfileToServer(immediate = false) {
            try {
                // Merge pending changes into main profile
                Object.keys(krushProfilePendingChanges).forEach(item => {
                    if (!krushProfile[item]) {
                        krushProfile[item] = [];
                    }
                    krushProfilePendingChanges[item].forEach(variant => {
                        if (!krushProfile[item].includes(variant)) {
                            krushProfile[item].push(variant);
                        }
                    });
                });
                
                if (Object.keys(krushProfilePendingChanges).length === 0 && !immediate) {
                    console.log('[KrushProfile] No pending changes to save');
                    return;
                }
                
                console.log(`[KrushProfile] Saving to server... (${Object.keys(krushProfilePendingChanges).length} pending changes)`);
                
                // TODO: Replace with actual server endpoint
                // const response = await fetch('/krush/profile/aliases', {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify({ aliases: krushProfilePendingChanges })
                // });
                // if (!response.ok) throw new Error('Failed to save profile');
                
                // For now, save to localStorage
                localStorage.setItem(KRUSH_PROFILE_KEY, JSON.stringify(krushProfile));
                
                krushProfileActive = Object.keys(krushProfile).length > 0;
                krushProfileLastSyncTime = new Date();
                krushProfilePendingChanges = {}; // Clear pending changes after successful save
                
                console.log('[KrushProfile] Saved to server successfully');
            } catch (e) {
                console.error('[KrushProfile] Failed to save to server:', e);
                // Keep pending changes for next sync attempt
                console.log('[KrushProfile] Pending changes queued for next sync');
            }
        }
        
        // Add voice variant to KrushProfile (queued for batch save)
        function learnVoiceVariant(itemName, spokenPhrase) {
            if (!krushProfile[itemName]) {
                krushProfile[itemName] = [];
            }
            
            const normalized = spokenPhrase.toLowerCase().trim();
            if (!krushProfile[itemName].includes(normalized)) {
                krushProfile[itemName].push(normalized);
                
                // Add to pending changes queue
                if (!krushProfilePendingChanges[itemName]) {
                    krushProfilePendingChanges[itemName] = [];
                }
                if (!krushProfilePendingChanges[itemName].includes(normalized)) {
                    krushProfilePendingChanges[itemName].push(normalized);
                }
                
                console.log(`[KrushProfile] Learned: "${normalized}" ‚Üí ${itemName} (queued for save)`);
            }
        }
        
        // Export KrushProfile as JSON file
        function downloadKrushProfile() {
            const profileData = {
                version: '1.0',
                created: new Date().toISOString(),
                items: krushProfile
            };
            
            const json = JSON.stringify(profileData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `krush_voice_profile_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        // Import KrushProfile from uploaded JSON
        function importKrushProfile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.items && typeof data.items === 'object') {
                            krushProfile = data.items;
                            saveKrushProfile();
                            krushProfileActive = true;
                            resolve(Object.keys(krushProfile).length);
                        } else {
                            reject(new Error('Invalid profile format'));
                        }
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }
        
        // Start 3-minute auto-save timer
        function startKrushProfileAutoSave() {
            // Clear any existing timer
            if (krushProfileAutoSaveTimer) {
                clearInterval(krushProfileAutoSaveTimer);
            }
            
            // Auto-save every 3 minutes (180,000 ms)
            krushProfileAutoSaveTimer = setInterval(async () => {
                console.log('[KrushProfile] 3-minute auto-save triggered');
                await saveKrushProfileToServer();
            }, 180000); // 3 minutes
            
            console.log('[KrushProfile] 3-minute auto-save timer started');
        }
        
        // Stop auto-save timer
        function stopKrushProfileAutoSave() {
            if (krushProfileAutoSaveTimer) {
                clearInterval(krushProfileAutoSaveTimer);
                krushProfileAutoSaveTimer = null;
                console.log('[KrushProfile] Auto-save timer stopped');
            }
        }
        
        // App leave detection - save immediately before leaving
        function setupAppLeaveDetection() {
            // Browser visibility change (tab hidden/shown)
            document.addEventListener('visibilitychange', async () => {
                if (document.hidden) {
                    console.log('[KrushProfile] App backgrounded - saving immediately');
                    await saveKrushProfileToServer(true);
                } else {
                    console.log('[KrushProfile] App foregrounded - resuming auto-save');
                    startKrushProfileAutoSave();
                }
            });
            
            // Page hide (more reliable than beforeunload)
            window.addEventListener('pagehide', async () => {
                console.log('[KrushProfile] Page hiding - saving immediately');
                await saveKrushProfileToServer(true);
            });
            
            // Before unload (best-effort, may not complete)
            window.addEventListener('beforeunload', async () => {
                console.log('[KrushProfile] Before unload - attempting save');
                // Use synchronous localStorage as fallback since async may not complete
                try {
                    localStorage.setItem(KRUSH_PROFILE_KEY, JSON.stringify(krushProfile));
                } catch (e) {
                    console.error('[KrushProfile] Emergency save failed:', e);
                }
            });
            
            console.log('[KrushProfile] App leave detection enabled');
        }
        
        // Initialize KrushProfile on page load (always-on server-side)
        (async () => {
            await loadKrushProfileFromServer();
            startKrushProfileAutoSave();
            setupAppLeaveDetection();
            console.log('[KrushProfile] Always-on server-side profile fully initialized');
        })();
        
        // ============================================
        // BACKGROUND FILE MANAGEMENT
        // ============================================
        
        function initBackgroundFiles() {
            // KrushProfile is now always-on server-side, no manual initialization needed
            console.log('[KrushProfile] Always-on server-side profile active')
            
            // Check for existing alias data in localStorage
            const aliasBackupKey = 'krushflow_aliases_backup_v1';
            const storedAliases = localStorage.getItem(aliasBackupKey);
            if (storedAliases) {
                try {
                    dailyAliases = JSON.parse(storedAliases);
                    console.log('Restored aliases from background storage');
                } catch (e) {
                    console.error('Failed to restore aliases:', e);
                }
            }
        }
        
        // Auto-save aliases to background storage
        function backgroundSaveAliases() {
            const aliasBackupKey = 'krushflow_aliases_backup_v1';
            try {
                localStorage.setItem(aliasBackupKey, JSON.stringify(dailyAliases));
                console.log('Background alias save complete');
            } catch (e) {
                console.error('Background alias save failed:', e);
            }
        }
        
        // Initialize background management
        initBackgroundFiles();
        
        let inventoryCounts = {};
        let unmappedCommands = [];
        let autoMatchQueue = []; // Medium confidence matches awaiting confirmation
        let commandHistory = [];
        let dailyMediaRecorder = null;
        let dailyAudioChunks = [];
        let isDailyRecording = false;

        // Setup file handlers
        const dailyCountInventoryZone = document.getElementById('dailyCountInventoryZone');
        const dailyCountInventoryInput = document.getElementById('dailyCountInventoryInput');
        const dailyCountAliasZone = document.getElementById('dailyCountAliasZone');
        const dailyCountAliasInput = document.getElementById('dailyCountAliasInput');

        dailyCountInventoryZone.addEventListener('click', () => dailyCountInventoryInput.click());
        dailyCountAliasZone.addEventListener('click', () => dailyCountAliasInput.click());

        dailyCountInventoryInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const lines = text.split('\n').filter(line => line.trim());
                
                dailyInventory = lines.slice(1).map(line => {
                    const match = line.match(/^"([^"]*)"/);                    const itemName = match ? match[1] : line.split(',')[0].trim();
                    return normalizeDisplayText(itemName);
                }).filter(item => item);;

                if (dailyInventory.length === 0) {
                    throw new Error('No items found in inventory file');
                }

                // Initialize counts to 0
                dailyInventory.forEach(item => {
                    inventoryCounts[item] = 0;
                });

                document.getElementById('dailyCountInventoryStatus').classList.remove('hidden');
                document.getElementById('dailyCountInventoryCount').textContent = dailyInventory.length;
                document.getElementById('dailyCountSetupStatus').classList.remove('hidden');
                
                checkStartCountReady();
            } catch (error) {
                showDailyCountSetupError('Error loading inventory: ' + error.message);
            }
        });

        dailyCountAliasInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const lines = text.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    throw new Error('Alias file is empty or has no data rows');
                }
                
                const dataLines = lines.slice(1);
                dailyAliases = {};
                
                for (const line of dataLines) {
                    const csvMatch = line.match(/^"([^"]*)","(.*)"/);
                    
                    if (csvMatch) {
                        const itemName = csvMatch[1].trim();
                        const aliasesString = csvMatch[2].trim();
                        
                        if (itemName) {
                            const aliases = aliasesString
                                .split(',')
                                .map(a => a.trim())
                                .filter(a => a);
                            
                            dailyAliases[itemName] = [...new Set(aliases)];
                        }
                    }
                }
                
                if (Object.keys(dailyAliases).length === 0) {
                    throw new Error('No valid alias data found in file');
                }

                document.getElementById('dailyCountAliasStatus').classList.remove('hidden');
                document.getElementById('dailyCountAliasCount').textContent = Object.keys(dailyAliases).length;
                document.getElementById('dailyCountSetupStatus').classList.remove('hidden');
                
                checkStartCountReady();
            } catch (error) {
                showLoadingState('Syncing Inventory Data...'); setTimeout(() => hideLoadingState(), 1000);
            }
        });

        // REMOVED: KrushProfile upload handlers (now always-on server-side)

        function checkStartCountReady() {
            const button = document.getElementById('startCountButton');
            if (dailyInventory.length > 0) {
                // Enable button if we have inventory (aliases are optional)
                // If no aliases, we'll try to match exact item names
                if (Object.keys(dailyAliases).length === 0) {
                    // Initialize empty aliases - will try exact name matching
                    dailyInventory.forEach(item => {
                        dailyAliases[item] = [item];
                    });
                }
                button.disabled = false;
            }
        }

        document.getElementById('startCountButton').addEventListener('click', () => {
            // CRITICAL: Clear all state before starting new session
            inventoryCounts = {};
            commandHistory = [];
            unmappedCommands = [];
            hasUnsavedChanges = false;
            
            // Clear any existing auto-save timer
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = null;
            }
            
            // Initialize counts to zero for all items
            dailyInventory.forEach(item => {
                inventoryCounts[item] = 0;
            });
            
            // Hide setup, show interface
            document.getElementById('dailyCountSetup').classList.add('hidden');
            document.getElementById('dailyCountInterface').classList.remove('hidden');
            document.getElementById('finishCountButton').classList.add('hidden');
            
            // Render initial state
            renderDailyInventoryList();
            updateDailyCountProgress();
            
            console.log('Daily Count session started - state cleared');
        });

        // Voice recording for Daily Count
        document.getElementById('dailyRecordButton').addEventListener('click', toggleDailyRecording);

        // clearLastCommand removed - no last-command UI

        async function toggleDailyRecording() {
            if (isDailyRecording) {
                stopDailyRecording();
            } else {
                await startDailyRecording();
            }
        }

        async function startDailyRecording() {
            try {
                // Clear previous error and command display
                document.getElementById('dailyCountError').classList.add('hidden');
                clearLastCommand();

                // Check for HTTPS (required for getUserMedia)
                if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                    throw new Error('HTTPS_REQUIRED');
                }

                // Disable record button to prevent double-start
                const recordButton = document.getElementById('dailyRecordButton');
                recordButton.disabled = true;

                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Check if MediaRecorder is supported
                if (!window.MediaRecorder) {
                    throw new Error('MEDIARECORDER_NOT_SUPPORTED');
                }
                
                dailyMediaRecorder = new MediaRecorder(stream);
                dailyAudioChunks = [];

                dailyMediaRecorder.ondataavailable = (event) => {
                    dailyAudioChunks.push(event.data);
                };

                dailyMediaRecorder.onstop = async () => {
                    try {
                        const audioBlob = new Blob(dailyAudioChunks, { type: 'audio/webm' });
                        await processDailyVoiceCommand(audioBlob);
                    } catch (err) {
                        console.error('Error processing voice command:', err);
                        showDailyCountError('Speech-to-text failed. Check connection and try again.');
                    } finally {
                        stream.getTracks().forEach(track => track.stop());
                    }
                };

                dailyMediaRecorder.onerror = (event) => {
                    console.error('MediaRecorder error:', event.error);
                    showDailyCountError('Recording failed: ' + event.error.name);
                    resetDailyRecordingState();
                };

                dailyMediaRecorder.start();
                isDailyRecording = true;
                enableRecordingLock(); // Prevent navigation while recording
                
                // Re-enable button (now shows "Stop")
                recordButton.disabled = false;
                document.getElementById('dailyRecordButtonText').textContent = 'Stop';
                document.getElementById('dailyCountStatus').innerHTML = `
                    <h4 class="text-xl font-semibold mb-2 text-red-400">üé§Ô∏è Recording...</h4>
                    <p class="text-zinc-400">Speak your count command now</p>
                `;
                document.getElementById('dailyCountStatus').className = 'bg-red-500/20 border border-red-500/50 rounded-xl p-6 mb-6 text-center';

            } catch (error) {
                console.error('Daily Count record error:', error);
                
                // Reset state on error
                resetDailyRecordingState();
                
                // Show user-friendly error message based on error type
                let errorMessage = 'Recording failed. Please try again.';
                
                if (error.message === 'HTTPS_REQUIRED') {
                    errorMessage = 'üîí Mic recording requires HTTPS.';
                } else if (error.message === 'MEDIARECORDER_NOT_SUPPORTED') {
                    errorMessage = '‚ö†Ô∏è Your browser does not support audio recording.';
                } else if (error.name === 'NotAllowedError') {
                    errorMessage = 'üé§ Microphone permission denied. Enable it in browser settings.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'üîç No microphone found.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = 'üö´ Microphone is in use by another app.';
                } else if (error.name === 'OverconstrainedError') {
                    errorMessage = '‚ö†Ô∏è Microphone configuration error.';
                } else if (error.name === 'SecurityError') {
                    errorMessage = 'üîí Microphone access blocked by security policy.';
                } else if (error.message) {
                    errorMessage = 'Recording error: ' + error.message;
                }
                
                showDailyCountError(errorMessage);
            }
        }
        
        // Helper function to reset recording state
        function resetDailyRecordingState() {
            isDailyRecording = false;
            disableRecordingLock(); // Release lock on error/reset
            const recordButton = document.getElementById('dailyRecordButton');
            if (recordButton) {
                recordButton.disabled = false;
            }
            document.getElementById('dailyRecordButtonText').textContent = 'Record';
            
            // Stop any active tracks
            if (dailyMediaRecorder && dailyMediaRecorder.stream) {
                dailyMediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
        }

        function stopDailyRecording() {
            if (dailyMediaRecorder && dailyMediaRecorder.state !== 'inactive') {
                dailyMediaRecorder.stop();
                isDailyRecording = false;
                disableRecordingLock(); // Release navigation lock
                document.getElementById('dailyRecordButtonText').textContent = 'Record';
                // DOM rewrite removed to prevent layout reflow during processing
            }
        }

        let recordingLockEnabled = false;

        function enableRecordingLock() {
            recordingLockEnabled = true;
            // Prevent navigation with beforeunload event
            window.addEventListener('beforeunload', recordingLockHandler);
        }

        function disableRecordingLock() {
            recordingLockEnabled = false;
            window.removeEventListener('beforeunload', recordingLockHandler);
        }

        function recordingLockHandler(e) {
            if (recordingLockEnabled) {
                // Standard way to trigger browser confirmation dialog
                e.preventDefault();
                e.returnValue = 'Recording in progress. Stop recording before leaving.';
                return e.returnValue;
            }
        }

        function setAPIStatus(status) {
            const indicator = document.getElementById('apiStatusIndicator');
            if (!indicator) return;
            
            if (status === 'busy') {
                indicator.className = 'w-3 h-3 rounded-full bg-red-500 transition-colors duration-300';
                indicator.title = 'API Status: Processing...';
            } else {
                indicator.className = 'w-3 h-3 rounded-full bg-green-500 transition-colors duration-300';
                indicator.title = 'API Status: Ready';
            }
        }

        function attemptLocalMapping(transcription, inventory, aliases) {
            // Local-first mapping: parse operation + value + item match
            const lower = transcription.toLowerCase().trim();
            
            // Extract action and value
            let action = 'set'; // default
            let value = null;
            let itemPhrase = lower;
            
            // Detect operation keywords
            if (lower.includes('set') || lower.includes('total') || lower.includes('have')) {
                action = 'set';
            } else if (lower.includes('add') || lower.includes('plus') || lower.includes('more')) {
                action = 'add';
            } else if (lower.includes('subtract') || lower.includes('minus') || lower.includes('less')) {
                action = 'subtract';
            } else if (lower.includes('multiply') || lower.includes('times')) {
                action = 'multiply';
            } else if (lower.includes('divide') || lower.includes('over')) {
                action = 'divide';
            }
            
            // Extract numeric value
            const numberMatch = lower.match(/\b(\d+(\.\d+)?)\b/);
            if (numberMatch) {
                value = parseFloat(numberMatch[1]);
                // Remove the number from item phrase for matching
                itemPhrase = lower.replace(numberMatch[0], '').trim();
            }
            
            if (value === null) {
                return { success: false }; // No numeric value found
            }
            
            // Remove operation keywords from item phrase
            const keywords = ['set', 'add', 'subtract', 'multiply', 'divide', 'plus', 'minus', 'times', 'over', 'total', 'have', 'more', 'less', 'to', 'by'];
            keywords.forEach(kw => {
                itemPhrase = itemPhrase.replace(new RegExp('\\b' + kw + '\\b', 'g'), '');
            });
            itemPhrase = itemPhrase.trim();
            
            // Attempt exact match in inventory
            const exactMatch = inventory.find(item => item.toLowerCase() === itemPhrase);
            if (exactMatch) {
                return { success: true, item: exactMatch, action, value };
            }
            
            // Attempt alias match
            for (const [canonical, aliasList] of Object.entries(aliases)) {
                if (aliasList.some(alias => alias.toLowerCase() === itemPhrase)) {
                    return { success: true, item: canonical, action, value };
                }
            }
            
            // Attempt partial match (only if unambiguous)
            const partialMatches = inventory.filter(item => 
                item.toLowerCase().includes(itemPhrase) || itemPhrase.includes(item.toLowerCase())
            );
            if (partialMatches.length === 1) {
                return { success: true, item: partialMatches[0], action, value };
            }
            
            // No unambiguous match - fall back to LLM
            return { success: false };
        }

        async function processDailyVoiceCommand(audioBlob) {
            try {
                // Step 1: Get transcription from Google STT
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');

                setAPIStatus('busy'); // Red light - API call starting
                const transcriptRes = await fetch('/process-voice', {
                    method: 'POST',
                    body: formData
                });

                const transcriptData = await transcriptRes.json();
                setAPIStatus('ready'); // Green light - STT complete

                if (!transcriptRes.ok) {
                    throw new Error(transcriptData.details || transcriptData.error || 'Transcription failed');
                }

                const transcription = transcriptData.transcription.trim();
                lastTranscriptionAttempt = transcription; // Store for error feedback

                if (!transcription) {
                    showDailyCountError('No speech detected. Please try again.');
                    resetDailyStatus();
                    return;
                }

                // Step 1.5: Local-first mapping attempt (fast path)
                const localResult = attemptLocalMapping(transcription, dailyInventory, dailyAliases);
                if (localResult.success) {
                    // Unambiguous local match found - apply immediately
                    const oldCount = inventoryCounts[localResult.item] || 0;
                    let newCount;
                    
                    if (localResult.action === 'set') {
                        newCount = localResult.value;
                    } else if (localResult.action === 'add') {
                        newCount = oldCount + localResult.value;
                    } else if (localResult.action === 'subtract') {
                        newCount = oldCount - localResult.value;
                    } else if (localResult.action === 'multiply') {
                        newCount = oldCount * localResult.value;
                    } else if (localResult.action === 'divide') {
                        if (localResult.value === 0) {
                            unmappedCommands.push({
                                raw_text: transcription,
                                reason: 'divide by zero',
                                suggested_item: localResult.item,
                                item_phrase: transcription,
                                count_value: null
                            });
                            renderUnmappedCommands();
                            resetDailyStatus();
                            return;
                        }
                        newCount = oldCount / localResult.value;
                    } else {
                        newCount = localResult.value; // default to set
                    }
                    
                    inventoryCounts[localResult.item] = newCount;
                    commandHistory.push({
                        item: localResult.item,
                        oldCount: oldCount,
                        newCount: newCount,
                        action: localResult.action || 'set',
                        value: localResult.value
                    });
                    
                    renderDailyInventoryList();
                    updateDailyCountProgress();
                    resetDailyStatus();
                    return; // Skip LLM call - local mapping succeeded
                }

                // Step 2: Interpret command with Claude (MULTI-ITEM endpoint)
                setAPIStatus('busy'); // Red light - LLM interpret starting
                const interpretRes = await fetch('/interpret-multi-count', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        transcription: transcription,
                        inventory: dailyInventory,
                        aliases: dailyAliases,
                        userVoiceProfile: krushProfile // Personalized voice history
                    })
                });

                const interpretData = await interpretRes.json();
                setAPIStatus('ready'); // Green light - interpret complete

                if (!interpretRes.ok) {
                    throw new Error(interpretData.details || interpretData.error || 'Interpretation failed');
                }

                const interpretation = interpretData.interpretation;

                // Step 3: Process results - may have multiple items
                let updatedCount = 0;
                let itemUpdates = [];
                
                if (interpretation.items && interpretation.items.length > 0) {
                    interpretation.items.forEach(itemResult => {
                        const oldCount = inventoryCounts[itemResult.item] || 0;
                        let newCount;
                        
                        // Apply action-based logic
                        if (itemResult.action) {
                            // Backend provides action/value
                            const value = itemResult.value || itemResult.count || 0;
                            if (itemResult.action === 'set') {
                                newCount = value;
                            } else if (itemResult.action === 'add') {
                                newCount = oldCount + value;
                            } else if (itemResult.action === 'subtract') {
                                newCount = oldCount - value;
                            } else if (itemResult.action === 'multiply') {
                                newCount = oldCount * value;
                            } else if (itemResult.action === 'divide') {
                                if (value === 0) {
                                    // Divide by zero - route to unmapped
                                    unmappedCommands.push({
                                        raw_text: itemResult.recorded_item || itemResult.item,
                                        reason: 'divide by zero',
                                        suggested_item: itemResult.item,
                                        item_phrase: itemResult.recorded_item || itemResult.item,
                                        count_value: null
                                    });
                                    return; // Skip this item, don't apply (forEach uses return, not continue)
                                }
                                newCount = oldCount / value;
                            } else {
                                newCount = value; // fallback to set
                            }
                        } else {
                            // Fallback: try to infer action from transcription
                            const count = itemResult.count || 0;
                            const lowerTranscription = transcription.toLowerCase();
                            
                            if (count < 0) {
                                // Negative = subtract
                                newCount = oldCount + count; // count is already negative
                            } else if (lowerTranscription.includes('set') || lowerTranscription.includes('total') || lowerTranscription.includes('have')) {
                                // Contains "set", "total", or "have" = set to exact value
                                newCount = count;
                            } else if (lowerTranscription.includes('multiply') || lowerTranscription.includes('times')) {
                                // Contains "multiply" or "times" = multiply
                                newCount = oldCount * count;
                            } else if (lowerTranscription.includes('divide') || lowerTranscription.includes('over')) {
                                // Contains "divide" or "over" = divide
                                if (count === 0) {
                                    // Divide by zero - route to unmapped
                                    unmappedCommands.push({
                                        raw_text: itemResult.recorded_item || itemResult.item,
                                        reason: 'divide by zero',
                                        suggested_item: itemResult.item,
                                        item_phrase: itemResult.recorded_item || itemResult.item,
                                        count_value: null
                                    });
                                    return; // Skip this item, don't apply (forEach uses return, not continue)
                                }
                                newCount = oldCount / count;
                            } else if (lowerTranscription.includes('add') || lowerTranscription.includes('plus') || lowerTranscription.includes('more')) {
                                // Contains "add", "plus", or "more" = add
                                newCount = oldCount + count;
                            } else if (lowerTranscription.includes('subtract') || lowerTranscription.includes('minus') || lowerTranscription.includes('less')) {
                                // Contains "subtract", "minus", or "less" = subtract
                                newCount = oldCount - count;
                            } else {
                                // Default = set (safest default)
                                newCount = count;
                            }
                        }
                        
                        // Allow negative totals for running tally correctness
                        // newCount can go negative
                        inventoryCounts[itemResult.item] = newCount;
                        
                        // Save to history for undo
                        commandHistory.push({
                            item: itemResult.item,
                            oldCount: oldCount,
                            newCount: newCount,
                            action: itemResult.action || 'set',
                            value: itemResult.value || itemResult.count || 0,
                            transcription: transcription
                        });
                        
                        itemUpdates.push(`${itemResult.item}: ${newCount}`);
                        updatedCount++;
                    });
                    
                    // Update UI
                    renderDailyInventoryList();
                    updateDailyCountProgress();
                    checkFinishButtonVisibility();
                    
                    // Last-command UI removed for mapped items - only unmapped items trigger UI updates
                    // Mapped successes no longer populate the last-command area
                }
                
                // Handle unmapped items
                let unmappedCount = 0;
                if (interpretation.unmapped && interpretation.unmapped.length > 0) {
                    interpretation.unmapped.forEach(unmapped => {
                        unmappedCommands.push({
                            raw_text: unmapped.raw_text,
                            reason: unmapped.reason,
                            suggested_item: unmapped.suggested_item || '',
                            item_phrase: unmapped.item_phrase || unmapped.raw_text,
                            count_value: unmapped.count_value !== undefined ? unmapped.count_value : null
                        });
                    });
                    unmappedCount = interpretation.unmapped.length;
                    renderUnmappedCommands();
                }
                
                // Summary display removed - unmapped items are shown via renderUnmappedCommands()
                
                resetDailyStatus();
                
            } catch (error) {
                console.error('Daily voice command error:', error);
                setAPIStatus('ready'); // Reset to green on error
                showDailyCountError(error.message || 'Failed to process voice command');
                resetDailyStatus();
            }
        }

        function resetDailyStatus() {
            document.getElementById('dailyCountStatus').innerHTML = `
                <h4 class="text-xl font-semibold mb-2">Press "Record" to count next item</h4>
                <p class="text-zinc-400">Say something like: "ribeyes twelve" or "we have 5 sirloins"</p>
            `;
            document.getElementById('dailyCountStatus').className = 'bg-zinc-800/50 rounded-xl p-6 mb-6 text-center';
        }

        // lastCommandData removed - no last-command UI

        // showLastCommand removed - no last-command UI

        // showStructuredLastCommand removed - no last-command UI

        // showMultiItemLastCommand removed - no last-command UI

        // Remap modal for correcting wrong mappings
        function openRemapModal(rawPhrase, currentMappedItem) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(4px);
            `;

            const dialog = document.createElement('div');
            dialog.className = 'bg-zinc-900 border border-zinc-800 rounded-2xl p-8 max-w-md w-full mx-4';
            dialog.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">Correct Mapping</h2>
                
                <div class="bg-orange-500/10 border border-orange-500/30 rounded-xl p-4 mb-4">
                    <div class="text-sm text-zinc-400 mb-2">Spoken phrase:</div>
                    <div class="font-semibold text-orange-300 mb-2">"${rawPhrase}"</div>
                    <div class="text-sm text-zinc-400 mb-1">Currently mapped to:</div>
                    <div class="font-semibold text-white">${currentMappedItem}</div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-zinc-300 mb-2">Search for correct item:</label>
                    <input type="text" id="remapSearchInput" 
                        class="w-full px-4 py-3 bg-zinc-800 border border-zinc-700 rounded-xl text-white focus:border-orange-500 focus:outline-none mb-2"
                        placeholder="Type to search items...">
                    <select id="remapItemSelect" size="6"
                        class="w-full px-4 py-3 bg-zinc-800 border border-zinc-700 rounded-xl text-white focus:border-orange-500 focus:outline-none">
                        ${dailyInventory.map(item => 
                            `<option value="${item}" ${item === currentMappedItem ? 'selected' : ''}>${item}</option>`
                        ).join('')}
                    </select>
                </div>

                <div class="flex gap-3">
                    <button id="cancelRemap" class="flex-1 py-3 bg-zinc-800 hover:bg-zinc-700 rounded-xl font-semibold transition-colors">
                        Cancel
                    </button>
                    <button id="confirmRemap" class="flex-1 py-3 gradient-primary hover:shadow-2xl hover:shadow-orange-500/50 rounded-xl font-semibold transition-all">
                        ‚úì Confirm Remap
                    </button>
                </div>
            `;

            modal.appendChild(dialog);
            document.body.appendChild(modal);

            // Searchable dropdown
            const searchInput = document.getElementById('remapSearchInput');
            const selectElement = document.getElementById('remapItemSelect');
            
            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.toLowerCase();
                const options = selectElement.options;
                
                for (let i = 0; i < options.length; i++) {
                    const option = options[i];
                    const itemText = option.textContent.toLowerCase();
                    
                    if (itemText.includes(searchTerm) || searchTerm === '') {
                        option.style.display = '';
                    } else {
                        option.style.display = 'none';
                    }
                }
            });

            document.getElementById('cancelRemap').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            document.getElementById('confirmRemap').addEventListener('click', () => {
                const newMappedItem = document.getElementById('remapItemSelect').value;

                if (!newMappedItem) {
                    alert('Please select an item');
                    return;
                }
                
                if (newMappedItem === currentMappedItem) {
                    document.body.removeChild(modal);
                    return;
                }

                // Fix: Only revert the last command, don't transfer entire count
                // Find the last command entry for this item
                const lastCommand = commandHistory.slice().reverse().find(cmd => cmd.item === currentMappedItem);
                
                if (lastCommand) {
                    // Revert old item to its previous count
                    inventoryCounts[currentMappedItem] = lastCommand.oldCount;
                    
                    // Apply the same action/value to the new item
                    const newItemOldCount = inventoryCounts[newMappedItem] || 0;
                    let newItemNewCount;
                    
                    if (lastCommand.action === 'set') {
                        newItemNewCount = lastCommand.value;
                    } else if (lastCommand.action === 'add') {
                        newItemNewCount = newItemOldCount + lastCommand.value;
                    } else if (lastCommand.action === 'subtract') {
                        newItemNewCount = newItemOldCount - lastCommand.value;
                    } else {
                        newItemNewCount = lastCommand.value;
                    }
                    
                    // Allow negative totals
                    inventoryCounts[newMappedItem] = newItemNewCount;
                    
                    // Update history entry
                    lastCommand.item = newMappedItem;
                    lastCommand.oldCount = newItemOldCount;
                    lastCommand.newCount = newItemNewCount;
                } else {
                    // Fallback if no history found (shouldn't happen)
                    console.warn('No history found for remap');
                }

                // Save alias: add rawPhrase as alias for newMappedItem
                const normalizedPhrase = rawPhrase.toLowerCase().trim();
                if (!dailyAliases[newMappedItem]) {
                    dailyAliases[newMappedItem] = [];
                }
                if (!dailyAliases[newMappedItem].includes(normalizedPhrase)) {
                    dailyAliases[newMappedItem].push(normalizedPhrase);
                    backgroundSaveAliases(); // Save to localStorage
                    showMicroBanner(`Alias saved: "${normalizedPhrase}" ‚Üí ${newMappedItem}`, 'success');
                }
                
                // Update KrushProfile
                learnVoiceVariant(newMappedItem, normalizedPhrase);

                // Update UI
                renderDailyInventoryList();
                updateDailyCountProgress();
                
                // Last-command display removed - no UI update needed for remap

                document.body.removeChild(modal);
            });
        }

        // Count edit modal
        function openCountEditModal(mappedItem, currentCount) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(4px);
            `;

            const dialog = document.createElement('div');
            dialog.className = 'bg-zinc-900 border border-zinc-800 rounded-2xl p-8 max-w-md w-full mx-4';
            dialog.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">Edit Count</h2>
                <div class="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4 mb-4">
                    <div class="text-sm text-zinc-400 mb-1">Item:</div>
                    <div class="font-semibold text-white">${mappedItem}</div>
                    <div class="text-sm text-zinc-500 mt-2">Current count: ${currentCount}</div>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-zinc-300 mb-2">New count:</label>
                    <input type="number" id="editCountInput" min="0" value="${currentCount}"
                        class="w-full px-4 py-3 bg-zinc-800 border border-zinc-700 rounded-xl text-white focus:border-blue-500 focus:outline-none"
                        placeholder="Enter new count">
                </div>

                <div class="flex gap-3">
                    <button id="cancelCountEdit" class="flex-1 py-3 bg-zinc-800 hover:bg-zinc-700 rounded-xl font-semibold transition-colors">
                        Cancel
                    </button>
                    <button id="confirmCountEdit" class="flex-1 py-3 bg-blue-600 hover:bg-blue-500 rounded-xl font-semibold transition-all">
                        ‚úì Update Count
                    </button>
                </div>
            `;

            modal.appendChild(dialog);
            document.body.appendChild(modal);

            document.getElementById('cancelCountEdit').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            document.getElementById('confirmCountEdit').addEventListener('click', () => {
                const newCount = parseInt(document.getElementById('editCountInput').value);

                if (isNaN(newCount) || newCount < 0) {
                    alert('Please enter a valid count (0 or greater)');
                    return;
                }

                // Update count (allow negative)
                const oldCount = inventoryCounts[mappedItem] || 0;
                inventoryCounts[mappedItem] = newCount;

                // Add to history for undo
                commandHistory.push({
                    item: mappedItem,
                    oldCount: oldCount,
                    newCount: newCount,
                    transcription: 'Manual count edit'
                });

                // Update UI
                renderDailyInventoryList();
                updateDailyCountProgress();
                checkFinishButtonVisibility();
                
                // Last-command display removed - no UI update needed for count edit

                document.body.removeChild(modal);
            });
        }

function renderDailyInventoryList() {
            const listDiv = document.getElementById('dailyInventoryList');
            
            if (dailyInventory.length === 0) {
                listDiv.innerHTML = '<div class="text-zinc-500 italic text-center p-4">No inventory loaded</div>';
                return;
            }

            listDiv.innerHTML = dailyInventory.map((item, index) => {
                const count = inventoryCounts[item] || 0;
                const hasCounted = count > 0;
                
                let className = 'p-4 transition-all';
                let style = '';
                
                if (hasCounted) {
                    // Fiery glass styling for counted items
                    className += ' hover:bg-zinc-800/50';
                    style = 'background: rgba(24, 24, 27, 0.6); border: 1px solid #f97316; border-radius: 0.75rem; margin-bottom: 0.5rem;';
                } else {
                    // Standard styling for uncounted items
                    className += ' hover:bg-zinc-800/50 border-b border-zinc-800';
                }

                return `
                    <div class="${className} cursor-pointer" style="${style}" onclick="openQuickAdjustModal('${item.replace(/'/g, "\\'")}')"
                        title="Tap to adjust count">
                        <div class="flex items-center justify-between">
                            <div class="font-semibold text-zinc-200">${normalizeDisplayText(item)}</div>
                            <div class="flex items-center gap-3">
                                <span class="text-2xl font-bold ${hasCounted ? 'text-orange-400' : 'text-zinc-600'}">${count}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openQuickAdjustModal(itemName) {
            const currentCount = inventoryCounts[itemName] || 0;
            
            // Create simple modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="glass-card max-w-sm w-full">
                    <h3 class="text-xl font-bold mb-4">Adjust Count</h3>
                    <p class="text-zinc-400 mb-2">${normalizeDisplayText(itemName)}</p>
                    <p class="text-zinc-500 text-sm mb-4">Current: ${currentCount}</p>
                    <input type="number" id="quickAdjustInput" value="${currentCount}" 
                        class="w-full bg-zinc-800 border border-zinc-700 rounded-lg p-3 text-white text-center text-2xl focus:border-orange-500 focus:outline-none mb-4">
                    <div class="flex gap-3">
                        <button id="quickAdjustSave" class="btn btn-primary flex-1">Save</button>
                        <button id="quickAdjustCancel" class="btn btn-glass">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Focus input and select all
            const input = document.getElementById('quickAdjustInput');
            setTimeout(() => {
                input.focus();
                input.select();
            }, 100);
            
            // Cancel handler
            document.getElementById('quickAdjustCancel').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // Save handler
            const saveHandler = () => {
                const newCount = parseFloat(input.value) || 0;
                const oldCount = inventoryCounts[itemName] || 0;
                
                if (newCount === oldCount) {
                    document.body.removeChild(modal);
                    return;
                }
                
                // Update count
                inventoryCounts[itemName] = newCount;
                
                // Add to history for undo
                commandHistory.push({
                    item: itemName,
                    oldCount: oldCount,
                    newCount: newCount,
                    transcription: 'Quick adjust'
                });
                
                // Update UI
                renderDailyInventoryList();
                updateDailyCountProgress();
                checkFinishButtonVisibility();
                
                document.body.removeChild(modal);
            };
            
            document.getElementById('quickAdjustSave').addEventListener('click', saveHandler);
            
            // Enter key to save
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveHandler();
                }
            });
        }

        function updateDailyCountProgress() {
            const countedItems = Object.values(inventoryCounts).filter(c => c > 0).length;
            const total = dailyInventory.length;
            const percentage = total > 0 ? (countedItems / total) * 100 : 0;
            
            document.getElementById('countProgress').style.width = `${percentage}%`;
            document.getElementById('countProgressText').textContent = `${countedItems} of ${total} items counted`;
        }


        // Auto-Match Confirmation Functions
        function renderAutoMatchQueue() {
            const section = document.getElementById('autoMatchSection');
            const list = document.getElementById('autoMatchList');
            
            if (autoMatchQueue.length === 0) {
                section.classList.add('hidden');
                return;
            }
            
            section.classList.remove('hidden');
            list.innerHTML = autoMatchQueue.map((match, index) => `
                <div class="bg-zinc-800 border border-orange-500/30 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <div class="text-sm text-zinc-400">You said:</div>
                            <div class="font-semibold text-zinc-200">"${match.transcription}"</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 mb-3">
                        <svg class="w-5 h-5 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                        </svg>
                        <div>
                            <div class="text-sm text-zinc-400">Matched to:</div>
                            <div class="font-bold text-orange-300">${match.item} = ${match.count}</div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="confirmAutoMatch(${index})" class="flex-1 py-2 bg-green-600 hover:bg-green-500 rounded-lg font-semibold transition-colors flex items-center justify-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Confirm
                        </button>
                        <button onclick="rejectAutoMatch(${index})" class="flex-1 py-2 bg-zinc-700 hover:bg-zinc-600 rounded-lg font-semibold transition-colors flex items-center justify-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            Reject
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function confirmAutoMatch(index) {
            const match = autoMatchQueue[index];
            
            // Apply the count (allow negative)
            const oldCount = inventoryCounts[match.item] || 0;
            inventoryCounts[match.item] = match.count;
            
            // Save to history for undo
            commandHistory.push({
                item: match.item,
                oldCount: oldCount,
                newCount: match.count,
                transcription: match.transcription
            });
            
            // PERSIST ALIAS: Add this spoken phrase to dailyAliases
            if (!dailyAliases[match.item]) {
                dailyAliases[match.item] = [];
            }
            const spokenPhrase = match.transcription.toLowerCase().trim();
            if (!dailyAliases[match.item].includes(spokenPhrase)) {
                dailyAliases[match.item].push(spokenPhrase);
                startAutoSaveTimer(); // Trigger auto-save for alias file
                backgroundSaveAliases(); // Background save to localStorage
                console.log(`Alias learned: "${spokenPhrase}" ‚Üí ${match.item}`);
            }
            
            // KRUSHPROFILE LEARNING: Add to personalized voice profile
            learnVoiceVariant(match.item, match.transcription);
            
            // Remove from queue
            autoMatchQueue.splice(index, 1);
            
            // Update UI
            renderDailyInventoryList();
            updateDailyCountProgress();
            renderAutoMatchQueue();
            checkFinishButtonVisibility();
            
            showMicroBanner(`Confirmed: "${match.transcription}" ‚Üí ${match.item}: ${match.count}`, 'success');
        }
        
        function rejectAutoMatch(index) {
            const match = autoMatchQueue[index];
            
            // Move to unmapped for manual resolution
            unmappedCommands.push({
                raw_text: match.transcription,
                reason: 'fuzzy match rejected by user',
                suggested_item: match.item,
                item_phrase: match.transcription,
                count_value: match.count
            });
            
            // Remove from queue
            autoMatchQueue.splice(index, 1);
            
            // Update UI
            renderAutoMatchQueue();
            renderUnmappedCommands();
            
            showMicroBanner(`Rejected match - moved to unmapped queue`, 'success');
        }
        // Quick access to unmapped resolution
        function openUnmappedResolution() {
            if (unmappedCommands.length > 0) {
                // Open first unmapped item for resolution
                const first = unmappedCommands[0];
                resolveUnmappedItem(first.raw_text, first.reason, first.suggested_item || "", first.item_phrase || first.raw_text, first.count_value !== null ? first.count_value : 0);
            }
        }

        function renderUnmappedCommands() {
            if (unmappedCommands.length === 0) {
                document.getElementById('unmappedSection').classList.add('hidden');
                checkFinishButtonVisibility();
                return;
            }

            document.getElementById('unmappedSection').classList.remove('hidden');
            const list = document.getElementById('unmappedList');
            
            list.innerHTML = unmappedCommands.map((cmd, index) => {
                // Extract suggestion fields if present
                const suggestedItem = cmd.suggested_item || '';
                const itemPhrase = cmd.item_phrase || cmd.raw_text;
                const countValue = cmd.count_value !== undefined ? cmd.count_value : null;
                
                return `
                    <div class="flex items-center justify-between p-3 bg-yellow-500/5 rounded hover:bg-yellow-500/10 transition-colors">
                        <div class="flex-1 cursor-pointer" onclick="resolveUnmappedItem('${cmd.raw_text.replace(/'/g, "\\'")}',' ${cmd.reason.replace(/'/g, "\\'")}',' ${suggestedItem.replace(/'/g, "\\'")}',' ${itemPhrase.replace(/'/g, "\\'")}',' ${countValue})">
                            <span class="text-zinc-300 font-medium">"${cmd.raw_text}"</span>
                            ${suggestedItem ? `<span class="text-orange-400 text-xs ml-2">üí° Suggested: ${suggestedItem}</span>` : ''}
                            <span class="text-zinc-500 text-xs ml-2">${cmd.reason}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="event.stopPropagation(); skipUnmappedItem(${index});" class="px-3 py-1 bg-zinc-700 hover:bg-zinc-600 text-zinc-300 rounded text-sm transition-colors">
                                Skip
                            </button>
                            <svg class="w-5 h-5 text-yellow-400 cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24" onclick="resolveUnmappedItem('${cmd.raw_text.replace(/'/g, "\\'")}',' ${cmd.reason.replace(/'/g, "\\'")}',' ${suggestedItem.replace(/'/g, "\\'")}',' ${itemPhrase.replace(/'/g, "\\'")}',' ${countValue})">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                            </svg>
                        </div>
                    </div>
                `;
            }).join('');
            
            checkFinishButtonVisibility();
        }

        function skipUnmappedItem(index) {
            if (index >= 0 && index < unmappedCommands.length) {
                // Remove the specific unmapped item from the queue
                unmappedCommands.splice(index, 1);
                // Re-render the unmapped list
                renderUnmappedCommands();
            }
        }

        function undoLastCommand() {
            if (commandHistory.length === 0) {
                alert('No commands to undo');
                return;
            }

            const lastCommand = commandHistory.pop();
            // Restore exact prior value (allow negative)
            inventoryCounts[lastCommand.item] = lastCommand.oldCount;
            
            renderCurrentCounts();
            // Last-command UI removed - undo no longer triggers last-command rendering
        }

        function resetCount() {
            if (!confirm('Reset all counts to zero? This cannot be undone.')) {
                return;
            }

            dailyInventory.forEach(item => {
                inventoryCounts[item] = 0;
            });
            
            commandHistory = [];
            unmappedCommands = [];
            
            renderDailyInventoryList();
            updateDailyCountProgress();
            renderUnmappedCommands();
        }

        // Manual unmapped resolution
// Updated manual resolution with alias persistence
        // ============================================
        // UX IMPROVEMENTS - LOADING STATES
        // ============================================
        
        let autoSaveTimer = null;
        let hasUnsavedChanges = false;

        function showLoadingState(message) {
            const banner = document.getElementById('microBanner');
            const content = document.getElementById('microBannerContent');
            const icon = document.getElementById('microBannerIcon');
            
            content.textContent = message;
            banner.classList.remove('hidden');
            
            icon.className = 'w-10 h-10 rounded-lg flex items-center justify-center bg-indigo-500/20';
            icon.innerHTML = '<div class="spinner"></div>';
        }

        function hideLoadingState() {
            const banner = document.getElementById('microBanner');
            banner.classList.add('hidden');
        }

        // Auto-save timer for alias changes
        function startAutoSaveTimer() {
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
            }
            
            hasUnsavedChanges = true;
            
            // Auto-download after 5 minutes of inactivity (background save)
            autoSaveTimer = setTimeout(() => {
                if (hasUnsavedChanges && Object.keys(dailyAliases).length > 0) {
                    downloadAliasesAuto();
                }
            }, 5 * 60 * 1000); // 5 minutes
        }

        function downloadAliasesAuto() {
            const timestamp = new Date().toISOString().slice(0,10);
            const filename = `inventory_aliases_${timestamp}_autosave.csv`;
            
            const csv = ['Line Item,Aliases\n'];
            for (const [item, aliases] of Object.entries(dailyAliases)) {
                if (aliases.length > 0) {
                    const aliasesString = aliases.join(', ');
                    csv.push(`"${item}","${aliasesString}"\n`);
                }
            }
            
            const blob = new Blob([csv.join('')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
            
            hasUnsavedChanges = false;
            showMicroBanner('üíæ Aliases auto-saved: ' + filename, 'success');;
        }

        function downloadAliasesOnFinish() {
            const timestamp = new Date().toISOString().slice(0,10);
            const filename = `inventory_aliases_${timestamp}.csv`;
            
            const csv = ['Line Item,Aliases\n'];
            for (const [item, aliases] of Object.entries(dailyAliases)) {
                if (aliases.length > 0) {
                    const aliasesString = aliases.join(', ');
                    csv.push(`"${item}","${aliasesString}"\n`);
                }
            }
            
            const blob = new Blob([csv.join('')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
            
            hasUnsavedChanges = false;
            
            // Small delay before downloading count CSV
            setTimeout(() => {
                finishCountDownload();
            }, 500);
        }

        function finishCountDownload() {
            const timestamp = new Date().toISOString().slice(0,10);
            
            // Generate CSV with ALL items in inventory order
            const csv = ['Item,Count\n'];
            dailyInventory.forEach(item => {
                csv.push(`"${item}",${inventoryCounts[item] || 0}\n`);
            });
            
            const blob = new Blob([csv.join('')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `daily_count_${timestamp}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            // Update last run timestamp
            localStorage.setItem(LS_LAST_INVENTORY_RUN_KEY, new Date().toISOString());
            
            const totalItems = dailyInventory.length;
            const countedItems = Object.values(inventoryCounts).filter(c => c > 0).length;
            showMicroBanner(`‚úì Count complete! ${countedItems}/${totalItems} items counted. Files downloaded.`, 'success');
        }


// Updated resolveUnmappedItem with searchable dropdown
        function resolveUnmappedItem(unmappedText, unmappedReason, suggestedItem = '', itemPhrase = '', countValue = null) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(4px);
            `;

            const dialog = document.createElement('div');
            dialog.className = 'bg-zinc-900 border border-zinc-800 rounded-2xl p-8 max-w-md w-full mx-4';
            dialog.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">Resolve Unmapped Command</h2>
                
                <!-- Spoken Phrase with Editable Alias -->
                <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4 mb-4">
                    <div class="text-sm text-zinc-400 mb-2">Spoken command:</div>
                    <div class="font-semibold text-yellow-300 mb-2">"${unmappedText}"</div>
                    
                    <!-- NEW: Phrase Selection Tool -->
                    <div class="mt-3">
                        <label class="block text-xs text-zinc-500 mb-1">Select phrase to use as alias:</label>
                        <input type="text" id="aliasPhrase" value="${itemPhrase || unmappedText}" 
                            class="w-full px-3 py-2 bg-zinc-800 border border-zinc-700 rounded-lg text-white text-sm focus:border-orange-500 focus:outline-none"
                            placeholder="Edit or select portion of command">
                        <p class="text-xs text-zinc-500 mt-1">√∞≈∏‚Äô¬° Tip: Edit to extract just the item name (e.g., "6 oz chicken breast")</p>
                    </div>
                    
                    <div class="text-sm text-zinc-500 mt-2">Reason: ${unmappedReason}</div>
                </div>
                
                <!-- Inventory Search (with pre-selection if suggested) -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-zinc-300 mb-2">Search inventory:</label>
                    <input type="text" id="resolveSearchInput" 
                        value="${suggestedItem ? suggestedItem.toLowerCase() : ''}"
                        class="w-full px-4 py-3 bg-zinc-800 border border-zinc-700 rounded-xl text-white focus:border-orange-500 focus:outline-none mb-2"
                        placeholder="Type to search items...">
                    <select id="resolveItemSelect" size="5"
                        class="w-full px-4 py-3 bg-zinc-800 border border-zinc-700 rounded-xl text-white focus:border-orange-500 focus:outline-none">
                        <option value="">-- Select item --</option>
                        ${dailyInventory.map(item => 
                            `<option value="${item}" ${item === suggestedItem ? 'selected' : ''}>${item}</option>`
                        ).join('')}
                    </select>
                </div>

                <!-- Count Input (pre-filled if extracted) -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-zinc-300 mb-2">Enter count:</label>
                    <input type="number" id="resolveCountInput" min="0" 
                        value="${countValue !== null ? countValue : ''}"
                        class="w-full px-4 py-3 bg-zinc-800 border border-zinc-700 rounded-xl text-white focus:border-orange-500 focus:outline-none"
                        placeholder="Enter quantity">
                </div>

                <div class="flex gap-3">
                    <button id="cancelResolve" class="flex-1 py-3 bg-zinc-800 hover:bg-zinc-700 rounded-xl font-semibold transition-colors">
                        Cancel
                    </button>
                    <button id="confirmResolve" class="flex-1 py-3 gradient-primary hover:shadow-2xl hover:shadow-orange-500/50 rounded-xl font-semibold transition-all">
                        ‚úì Apply & Save Alias
                    </button>
                </div>
            `;

            modal.appendChild(dialog);
            document.body.appendChild(modal);

            // Searchable dropdown functionality
            const searchInput = document.getElementById('resolveSearchInput');
            const selectElement = document.getElementById('resolveItemSelect');
            
            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.toLowerCase();
                const options = selectElement.options;
                
                for (let i = 0; i < options.length; i++) {
                    const option = options[i];
                    const itemText = option.textContent.toLowerCase();
                    
                    if (itemText.includes(searchTerm) || searchTerm === '') {
                        option.style.display = '';
                    } else {
                        option.style.display = 'none';
                    }
                }
            });

            document.getElementById('cancelResolve').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            document.getElementById('confirmResolve').addEventListener('click', () => {
                const selectedItem = document.getElementById('resolveItemSelect').value;
                const count = parseInt(document.getElementById('resolveCountInput').value);
                const aliasPhrase = document.getElementById('aliasPhrase').value.trim().toLowerCase();

                if (!selectedItem || isNaN(count) || count < 0) {
                    alert('Please select an item and enter a valid count');
                    return;
                }
                
                if (!aliasPhrase) {
                    alert('Please specify the phrase to use as an alias');
                    return;
                }

                // Apply count (ADDITIVE if item already has count)
                const oldCount = inventoryCounts[selectedItem] || 0;
                let newCount;
                
                if (oldCount > 0) {
                    // Item already counted - ADD to existing value
                    newCount = oldCount + count;
                    console.log(`Additive mapping: ${selectedItem} (${oldCount} + ${count} = ${newCount})`);
                } else {
                    // First time counting - SET value
                    newCount = count;
                }
                
                // Allow negative totals
                inventoryCounts[selectedItem] = newCount;

                // Add to history for undo
                commandHistory.push({
                    item: selectedItem,
                    oldCount: oldCount,
                    newCount: newCount,
                    transcription: `Manual: ${unmappedText}`
                });

                // SAVE ALIAS (using the edited phrase, not full transcription)
                if (!dailyAliases[selectedItem]) {
                    dailyAliases[selectedItem] = [];
                }
                if (!dailyAliases[selectedItem].includes(aliasPhrase)) {
                    dailyAliases[selectedItem].push(aliasPhrase);
                    startAutoSaveTimer();
                    backgroundSaveAliases(); // Background save to localStorage
                    showMicroBanner(`üíæ Alias saved: "${aliasPhrase}" ‚Üí ${selectedItem}`, 'success');
                }
                
                // KRUSHPROFILE LEARNING: Add to personalized voice profile
                learnVoiceVariant(selectedItem, aliasPhrase);

                // Remove from unmapped
                unmappedCommands = unmappedCommands.filter(cmd => cmd.raw_text !== unmappedText);

                // Update UI
                renderDailyInventoryList();
                updateDailyCountProgress();
                renderUnmappedCommands();
                checkFinishButtonVisibility();

                // Last command display removed - no UI update needed

                document.body.removeChild(modal);
            });
        }
        function adjustItemCount(itemName) {
            const currentCount = inventoryCounts[itemName] || 0;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(4px);
            `;

            const dialog = document.createElement('div');
            dialog.className = 'bg-zinc-900 border border-zinc-800 rounded-2xl p-8 max-w-md w-full mx-4';
            dialog.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">Adjust Count</h2>
                <div class="bg-indigo-500/10 border border-indigo-500/30 rounded-xl p-4 mb-4">
                    <div class="text-sm text-zinc-400 mb-1">Item:</div>
                    <div class="font-semibold text-orange-300">${itemName}</div>
                    <div class="text-sm text-zinc-500 mt-2">Current count: ${currentCount}</div>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-zinc-300 mb-2">New count:</label>
                    <input type="number" id="adjustCountInput" min="0" value="${currentCount}"
                        class="w-full px-4 py-3 bg-zinc-800 border border-zinc-700 rounded-xl text-white focus:border-orange-500 focus:outline-none">
                </div>

                <div class="flex gap-3">
                    <button id="cancelAdjust" class="flex-1 py-3 bg-zinc-800 hover:bg-zinc-700 rounded-xl font-semibold transition-colors">
                        Cancel
                    </button>
                    <button id="confirmAdjust" class="flex-1 py-3 gradient-primary hover:shadow-2xl hover:shadow-orange-500/50 rounded-xl font-semibold transition-all">
                        Update
                    </button>
                </div>
            `;

            modal.appendChild(dialog);
            document.body.appendChild(modal);

            document.getElementById('cancelAdjust').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            document.getElementById('confirmAdjust').addEventListener('click', () => {
                const newCount = parseInt(document.getElementById('adjustCountInput').value);

                if (isNaN(newCount) || newCount < 0) {
                    alert('Please enter a valid count');
                    return;
                }

                // Save to history for undo
                commandHistory.push({
                    item: itemName,
                    oldCount: currentCount,
                    newCount: newCount,
                    transcription: `Manual adjustment`
                });

                // Allow negative totals
                inventoryCounts[itemName] = newCount;

                // Update UI
                renderDailyInventoryList();
                updateDailyCountProgress();
                checkFinishButtonVisibility();

                // Last command display removed - no UI update needed

                document.body.removeChild(modal);
            });
        }

        // Check if Finish button should be visible
        function checkFinishButtonVisibility() {
            const finishButton = document.getElementById('finishCountButton');
            const hasUnmapped = unmappedCommands.length > 0;
            const hasCounts = Object.values(inventoryCounts).some(c => c > 0);
            
            // Show Finish button only if:
            // 1. Has at least one count
            // 2. No unmapped commands OR user has reviewed them
            if (hasCounts && !hasUnmapped) {
                finishButton.classList.remove('hidden');
            } else {
                finishButton.classList.add('hidden');
            }
        }


// Updated finish function with state reset and return to home
        function finishCount() {
            // Download aliases first if there are changes
            if (hasUnsavedChanges || Object.keys(dailyAliases).some(k => dailyAliases[k].length > 0)) {
                downloadAliasesOnFinish();
            } else {
                finishCountDownload();
            }
            
            // Download KrushProfile (secret personalized voice profile)
            setTimeout(() => {
                if (krushProfileActive && Object.keys(krushProfile).length > 0) {
                    downloadKrushProfile();
                    showMicroBanner('üòç KrushProfile downloaded - keep this file safe!', 'success');
                }
            }, 500);
            
            // Reset state after download
            setTimeout(() => {
                resetDailyCountState();
                showModeSelection();
                showMicroBanner('‚úì Session complete. Ready for next count.', 'success');
            }, 1000);
        }

        function resetDailyCountState() {
            // Clear all Daily Count state
            dailyInventory = [];
            dailyAliases = {};
            inventoryCounts = {};
            commandHistory = [];
            unmappedCommands = [];
            hasUnsavedChanges = false;
            
            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = null;
            }
            
            // Hide interface, show setup
            document.getElementById('dailyCountInterface').classList.add('hidden');
            document.getElementById('dailyCountSetup').classList.remove('hidden');
            
            // Clear file inputs
            document.getElementById('dailyCountInventoryInput').value = '';
            document.getElementById('dailyCountAliasInput').value = '';
            
            // Hide status indicators
            document.getElementById('dailyCountInventoryStatus').classList.add('hidden');
            document.getElementById('dailyCountAliasStatus').classList.add('hidden');
            document.getElementById('dailyCountSetupStatus').classList.add('hidden');
            
            // Disable start button until files loaded again
            document.getElementById('startCountButton').disabled = true;
        }
        function cancelCount() {
            if (!confirm('Cancel counting? All progress will be lost.')) {
                return;
            }
            
            document.getElementById('dailyCountInterface').classList.add('hidden');
            document.getElementById('dailyCountSetup').classList.remove('hidden');
            
            // Reset state
            dailyInventory.forEach(item => {
                inventoryCounts[item] = 0;
            });
            commandHistory = [];
            unmappedCommands = [];
        }

        function showDailyCountSetupError(message) {
            const errorDiv = document.getElementById('dailyCountSetupError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        let lastTranscriptionAttempt = '';

        function showDailyCountError(message) {
            const errorDiv = document.getElementById('dailyCountError');
            let fullMessage = message;
            
            // Append last transcription if available (helps with debugging)
            if (lastTranscriptionAttempt) {
                fullMessage += ` | Last recorded: "${lastTranscriptionAttempt}"`;
            }
            
            errorDiv.textContent = fullMessage;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 8000); // Longer timeout for more info
        }

        // Initialize on page load
        updateLastRunDisplay();

        // ============================================
        // EXCEL IMPORT
        // ============================================

        let excelData = null;

        function openExcelImportModal() {
            document.getElementById('excelImportModal').classList.remove('hidden');
            document.getElementById('excelColumnSelector').classList.add('hidden');
            document.getElementById('excelImportStatus').classList.add('hidden');
            document.getElementById('excelFileInput').value = '';
            excelData = null;
        }

        function closeExcelImportModal() {
            document.getElementById('excelImportModal').classList.add('hidden');
        }

        async function handleExcelFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const statusDiv = document.getElementById('excelImportStatus');
            
            try {
                // Read file as array buffer
                const arrayBuffer = await file.arrayBuffer();
                
                // Send to server for parsing (requires xlsx library server-side)
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('/parse-excel', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Failed to parse Excel file');
                }
                
                excelData = await response.json();
                
                // Populate column selectors
                const itemSelect = document.getElementById('itemColumnSelect');
                const countSelect = document.getElementById('countColumnSelect');
                
                itemSelect.innerHTML = '';
                countSelect.innerHTML = '';
                
                excelData.columns.forEach((col, idx) => {
                    const itemOption = document.createElement('option');
                    itemOption.value = idx;
                    itemOption.textContent = col;
                    itemSelect.appendChild(itemOption);
                    
                    const countOption = document.createElement('option');
                    countOption.value = idx;
                    countOption.textContent = col;
                    countSelect.appendChild(countOption);
                });
                
                // Show column selector
                document.getElementById('excelColumnSelector').classList.remove('hidden');
                
            } catch (error) {
                console.error('Excel file error:', error);
                statusDiv.textContent = 'Failed to read Excel file. Please try again.';
                statusDiv.className = 'mt-3 p-3 rounded-lg text-sm bg-red-500/10 border border-red-500/50 text-red-400';
                statusDiv.classList.remove('hidden');
            }
        }

        function processExcelImport() {
            if (!excelData) return;
            
            const itemColumnIdx = parseInt(document.getElementById('itemColumnSelect').value);
            const countColumnIdx = parseInt(document.getElementById('countColumnSelect').value);
            const statusDiv = document.getElementById('excelImportStatus');
            
            let imported = 0;
            let skipped = 0;
            
            // Process each row
            excelData.rows.forEach(row => {
                const itemName = row[itemColumnIdx]?.toString().trim();
                const countValue = parseFloat(row[countColumnIdx]);
                
                if (!itemName || isNaN(countValue)) {
                    skipped++;
                    return;
                }
                
                // Try to match to existing inventory items
                const matchedItem = dailyInventory.find(item => 
                    item.toLowerCase() === itemName.toLowerCase()
                );
                
                if (matchedItem) {
                    inventoryCounts[matchedItem] = countValue;
                    imported++;
                } else {
                    skipped++;
                }
            });
            
            // Update UI
            renderDailyInventoryList();
            updateDailyCountProgress();
            
            statusDiv.textContent = `Imported ${imported} counts. ${skipped} items skipped (not in master list).`;
            statusDiv.className = 'mt-3 p-3 rounded-lg text-sm bg-green-500/10 border border-green-500/50 text-green-400';
            statusDiv.classList.remove('hidden');
            
            // Close modal after 2 seconds
            setTimeout(() => {
                closeExcelImportModal();
            }, 2000);
        }

        // ============================================
        // FEEDBACK WIDGET
        // ============================================

        function openFeedbackModal() {
            document.getElementById('feedbackModal').classList.remove('hidden');
            document.getElementById('feedbackText').value = '';
            document.getElementById('feedbackStatus').classList.add('hidden');
        }

        function closeFeedbackModal() {
            document.getElementById('feedbackModal').classList.add('hidden');
        }

        async function submitFeedback() {
            const feedbackText = document.getElementById('feedbackText').value.trim();
            const statusDiv = document.getElementById('feedbackStatus');
            
            if (!feedbackText) {
                statusDiv.textContent = 'Please enter your feedback before submitting.';
                statusDiv.className = 'mt-3 p-3 rounded-lg text-sm bg-yellow-500/10 border border-yellow-500/50 text-yellow-400';
                statusDiv.classList.remove('hidden');
                return;
            }
            
            try {
                // Send feedback to server
                const response = await fetch('/submit-feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        feedback: feedbackText,
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent
                    })
                });
                
                if (response.ok) {
                    statusDiv.textContent = 'Thank you! Your feedback has been sent.';
                    statusDiv.className = 'mt-3 p-3 rounded-lg text-sm bg-green-500/10 border border-green-500/50 text-green-400';
                    statusDiv.classList.remove('hidden');
                    
                    // Close modal after 2 seconds
                    setTimeout(() => {
                        closeFeedbackModal();
                    }, 2000);
                } else {
                    throw new Error('Failed to submit feedback');
                }
            } catch (error) {
                console.error('Feedback submission error:', error);
                statusDiv.textContent = 'Failed to send feedback. Please try again later.';
                statusDiv.className = 'mt-3 p-3 rounded-lg text-sm bg-red-500/10 border border-red-500/50 text-red-400';
                statusDiv.classList.remove('hidden');
            }
        }

    </script>

</body>
</html>
